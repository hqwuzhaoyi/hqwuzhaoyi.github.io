<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>狼书 | Prajna's blog</title><meta name="keywords" content="koa,node"><meta name="author" content="Wu Zhaoyi,hqwuzhaoyi@foxmail.com"><meta name="copyright" content="Wu Zhaoyi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="http 知识请求响应模型 http.createServer创建一个 Server 实例,参数是requestListener函数,一般形式为function(req, res)  请求1GET &#x2F;a?b&#x3D;1  req.method的值为 GET,req.url为&#x2F;a?b&#x3D;1 响应res.writeHead的第一个参数为状态码,第二个参数为 HTTP Headers,没有指定的话,默认其为空对象">
<meta property="og:type" content="article">
<meta property="og:title" content="狼书">
<meta property="og:url" content="https://hqwuzhaoyi.github.io/2020/04/07/node/68.%E7%8B%BC%E4%B9%A6/index.html">
<meta property="og:site_name" content="Prajna&#39;s blog">
<meta property="og:description" content="http 知识请求响应模型 http.createServer创建一个 Server 实例,参数是requestListener函数,一般形式为function(req, res)  请求1GET &#x2F;a?b&#x3D;1  req.method的值为 GET,req.url为&#x2F;a?b&#x3D;1 响应res.writeHead的第一个参数为状态码,第二个参数为 HTTP Headers,没有指定的话,默认其为空对象">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wuzhaoyi-xyz.oss-cn-beijing.aliyuncs.com/vue/20200407153942.png">
<meta property="article:published_time" content="2020-04-07T00:00:00.000Z">
<meta property="article:modified_time" content="2022-08-29T03:13:16.652Z">
<meta property="article:author" content="Wu Zhaoyi">
<meta property="article:tag" content="koa">
<meta property="article:tag" content="node">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wuzhaoyi-xyz.oss-cn-beijing.aliyuncs.com/vue/20200407153942.png"><link rel="shortcut icon" href="https://wuzhaoyi-xyz.oss-cn-beijing.aliyuncs.com/favicon.ico?versionId=CAEQIBiBgICUj6fpxhciIGVlZDJjMTcyMGRkMjQ0MGViNDIyOWEyNDdkOGI5YjQ5"><link rel="canonical" href="https://hqwuzhaoyi.github.io/2020/04/07/node/68.%E7%8B%BC%E4%B9%A6/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4af216cebbf1ef8bfe277df5447157c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"LPQ2BDF707","apiKey":"b955341b8b62ac31533e2e1ff3aa5fd0","indexName":"wzy","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-29 03:13:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Prajna's blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://wuzhaoyi-xyz.oss-cn-beijing.aliyuncs.com/git20210416184339.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">123</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://wuzhaoyi-xyz.oss-cn-beijing.aliyuncs.com/vue/20200407153942.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Prajna's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">狼书</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-04-07T00:00:00.000Z" title="发表于 2020-04-07 00:00:00">2020-04-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-29T03:13:16.652Z" title="更新于 2022-08-29 03:13:16">2022-08-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/node/">node</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>57分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="狼书"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="http-知识"><a href="#http-知识" class="headerlink" title="http 知识"></a>http 知识</h1><h2 id="请求响应模型"><a href="#请求响应模型" class="headerlink" title="请求响应模型"></a>请求响应模型</h2><ul>
<li><code>http.createServer</code>创建一个 Server 实例,参数是<br><code>requestListener</code>函数,一般形式为<code>function(req, res)</code></li>
</ul>
<h3 id="请求"><a href="#请求" class="headerlink" title="请求"></a>请求</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /a?b=1</span><br></pre></td></tr></table></figure>

<p><code>req.method</code>的值为 GET,<code>req.url</code>为<code>/a?b=1</code></p>
<h3 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h3><p><code>res.writeHead</code>的第一个参数为状态码,第二个参数为 HTTP Headers,没有指定的话,默认其为空对象,<br><code>Content-Type</code>是 HTTP 头部信息里比较特殊的一个,它是<code>MIME</code>多用于互联网邮件扩展</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>后缀</th>
<th>Content-Type</th>
<th>游览器渲染</th>
</tr>
</thead>
<tbody><tr>
<td>普通文本</td>
<td>.txt</td>
<td>text/plain</td>
<td>文本</td>
</tr>
<tr>
<td>HTML</td>
<td>.html</td>
<td>text/html</td>
<td>网页</td>
</tr>
<tr>
<td>JSON</td>
<td>.json</td>
<td>application/json</td>
<td>JSON 文本</td>
</tr>
<tr>
<td>Gif</td>
<td>.gif</td>
<td>image/gif/图片</td>
<td></td>
</tr>
</tbody></table>
<p><code>res.end</code>是最简单粗暴向游览器写入数据的方法，</p>
<ul>
<li><code>res.write(chunk, encoding)</code></li>
<li><code>res.end(data, [, callback])</code>, 它完成了两项内容，分别是将参数<code>data</code>放到<code>body</code>中,以及向游览器发送<code>body</code>中的所有数据.</li>
</ul>
<h3 id="核心要点"><a href="#核心要点" class="headerlink" title="核心要点"></a>核心要点</h3><ul>
<li><code>EventEmiter</code>主要负责事件监听和处理,异步处理结合事件驱动可以获得更好的性能和易用性.</li>
<li><code>Stream</code>将请求响应过程抽象成一个流并在内存中传递,便于进行大文件处理,能够提高扩展性.</li>
</ul>
<h4 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h4><p><code>Stream</code>本身是一个抽象接口,Node.js 中有很多对象实现了这个接口,例如对 HTTP 服务器发起请求的 <code>request</code> 对象,以及 <code>stdout</code>(标准输出).<br>和 <code>UNIX</code> 类似,在 <code>Node.js</code> 中,流模块的基本操作符是<code>.pipe</code>,通过它可以直接将上一步的结果作为下一步的输入,<br>这是非常高效的做法,尤其适合 <code>Gulp</code> 等 <code>I/O</code> 密集型操作.</p>
<p><code>Stream</code>在<code>Node.js</code>中继承自<code>EventEmitter</code>,并且有多种实现方式.<br>|Readable Stream| Writable Stream|<br>|-:|:-|<br>|Http response, on the client| Http response, on the client|<br>|Http response, on the server| Http response, on the server|<br>|fz read stream|fz read stream|<br>|zlib stream|zlib stream|<br>|crypto stream|crypto stream|<br>|TCP socket|TCP socket|<br>|child process stdout and stderr|child process stdin|</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stream = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>Node.js Stream</code>有 5 中操作类型</p>
<ul>
<li>Readable 可读操作类型，可以产出数据，这些数据可以被传送到其他流中，只需要调用 pipe 方法即可</li>
<li>Writable 可写操作类型，只能流进不能流出</li>
<li>Duplex 可读可写操作类型</li>
<li>Transform 转换类型，可以写入数据，然后读出结果</li>
<li>classic 经典接口，现在不怎么使用</li>
</ul>
<h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>Stream 的精髓是将上一个输出作为下一个输入,这和 Linux 里管道的功能是一样的,比如查杀所有 Node.js 进程的命令如下.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep node | awk &#x27;&#123;print $2&#125;&#x27; | xargs kill -9</span><br></pre></td></tr></table></figure>

<p>以下命令的要点如下:</p>
<ul>
<li><code>ps -ef</code>: 查看活动进程</li>
<li><code>grep node</code>: 过滤并获得包含 node 在内的所有进程</li>
<li><code>awk &#39;&#123;print $2&#125;&#39;</code>: 通过 awk 获得包含 node 在内的所有进程号</li>
<li><code>xargs kill -9</code>: 通过 xargs 反转进程号,并作为 kill -9 的参数</li>
</ul>
<p>这就是典型的管道机制,将<code>ps -ef</code>的输出结果作为<code>grep node</code>的输入参数,达到一气呵成的结果</p>
<p>可以发现<code>request</code>对象和<code>response</code>对象其实都是继承自 Stream 的.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//request</span></span><br><span class="line">req =&gt; <span class="function"><span class="params">IncomingMessage</span> =&gt;</span> Stream.Readable</span><br><span class="line"><span class="comment">//response</span></span><br><span class="line">res =&gt; <span class="function"><span class="params">ServerResponse</span> =&gt;</span> <span class="function"><span class="params">OutgoingMessage</span> =&gt;</span> Stream</span><br></pre></td></tr></table></figure>

<p>http 连接中的<code>request</code>对象是可读流<code>Stream.Readable</code>,而<code>response</code>对象是完整的可读可写流<code>Stream.Duplex</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> client = http.request(&#123;</span><br><span class="line">  <span class="string">&#x27;host&#x27;</span>: <span class="string">&#x27;httpbin.org&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;patch&#x27;</span>: <span class="string">&#x27;/ip&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    res.setEncoding(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> str = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    res.on(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">      str += chunk</span><br><span class="line">    &#125;)</span><br><span class="line">    res.on(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(str)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">client.on(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;problem with request: $&#123;e.message&#125;&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">client.end()</span><br></pre></td></tr></table></figure>

<p>那么<code>http.request</code>又是如何实现的呢, <code>_http_client.js</code>中对外暴露的是<code>ClientRequest</code>, 而<code>ClientRequest</code>继承自<code>OutgoingMessage</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">util.inherits(ClientRequest, OutgoingMessage)</span><br></pre></td></tr></table></figure>

<p>OutgoingMessage 是继承自 Stream 的,所有 HTTP 过程都是 IncomingMessage 和 OutgoingMessage 的过程,其对应的就是请求和响应的过程.</p>
<h5 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> source = fs.readFileSync(<span class="string">&#x27;/path/to/source&#x27;</span>, &#123;<span class="attr">encoding</span>: <span class="string">&#x27;uft8&#x27;</span>&#125;)</span><br><span class="line">fs.writeFileSync(<span class="string">&#x27;/path/to/dest&#x27;</span>, source)</span><br></pre></td></tr></table></figure>

<p>等于</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pipe自动调用了data, end等事件</span></span><br><span class="line">fs.createReadStream(<span class="string">&#x27;/path/to/source&#x27;</span>).pipe(fs.createWriteStream(<span class="string">&#x27;/path/to/dest&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h5 id="Http-代理"><a href="#Http-代理" class="headerlink" title="Http 代理"></a>Http 代理</h5><p>请求和响应都是继承自 Stream 的,所以可以直接通过 pipe 方法进行组装.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;/remote&quot;</span> === req.url) &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123; <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/plain&quot;</span> &#125;);</span><br><span class="line">    <span class="keyword">return</span> res.end(<span class="string">&quot;Hello Remote Page\n&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    proxy(req, res);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> options = &#123;</span><br><span class="line">    host: req.host,</span><br><span class="line">    port: <span class="number">3000</span>,</span><br><span class="line">    headers: req.headers,</span><br><span class="line">    path: <span class="string">&quot;/remote&quot;</span>,</span><br><span class="line">    agent: <span class="literal">false</span>,</span><br><span class="line">    method: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> httpProxy = http.request(options, <span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    response.pipe(res);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  req.pipe(httpProxy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> PORT = app.address().port;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Server running at http://127.0.0.1:<span class="subst">$&#123;PORT&#125;</span>/`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>以上代码的执行要点如下：</p>
<ul>
<li>变量<code>httpProxy</code>是<code>http.request()</code>函数的返回值，是一个新的请求。</li>
<li>通过<code>req.pipe(httpProxy)</code>操作，req 就拥有了新的 res，即 HTTP 代理请求的响应，也就是说最终返回的是 response.</li>
<li>HTTP 代理完成了一次完整的 HTTP 请求过程，响应交由 res 返回，于是原来的请求相当于透传了 HTTP 代理的请求和响应。<br><code>http.request</code>方法的返回值是<code>&lt;http.ClientRequest&gt;</code>,该方法继承自 Outgoingmessage, 如此可以推导出如下关系。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.request =&gt; http.ClientRequest =&gt; <span class="function"><span class="params">OutgoingMessage</span> =&gt;</span> Stream</span><br></pre></td></tr></table></figure>

<h4 id="EventEmitter"><a href="#EventEmitter" class="headerlink" title="EventEmitter"></a>EventEmitter</h4><p>Node.js 中会使用事件驱动模型,事件是核心机制.EventEmitter 是 Node.js 里典型的基于观察者设计模式的实现类.</p>
<p>所有的 Stream 对象都是 EventEmitter 的实例.常见的事件有以下几类.</p>
<ul>
<li>data: 当有数据可读时触发.</li>
<li>end: 没有更多的数据可读时触发.</li>
<li>error: 接收和写入过程中发生错误时触发.</li>
<li>finish: 所有数据已被写入底层系统时触发.</li>
</ul>
<h4 id="请求事件"><a href="#请求事件" class="headerlink" title="请求事件"></a>请求事件</h4><p>请求事件有一个非常典型的例子,即保存请求向服务器传递过去的表单数据.这时可以用 req.on(‘data’, cb)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req)</span><br><span class="line">    <span class="keyword">if</span>(req.method === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; req.url ===<span class="string">&#x27;/echo&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> body = []</span><br><span class="line">        req.on(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(chunk)</span><br><span class="line">            body.push(chunk)</span><br><span class="line">        &#125;).on(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            body = Buffer.concat(body).toString()</span><br><span class="line">            res.end(body)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.statusCode = <span class="number">404</span></span><br><span class="line">        res.end()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3002</span>,<span class="function">()=&gt;</span><span class="built_in">console</span>.log(<span class="string">`Server running at http://127.0.0.1:<span class="subst">$&#123;app.address().port&#125;</span>`</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -d <span class="string">&quot;a=1&quot;</span> http://127.0.0.1:3002/<span class="built_in">echo</span></span></span><br><span class="line">a=1#</span><br></pre></td></tr></table></figure>

<h4 id="响应事件"><a href="#响应事件" class="headerlink" title="响应事件"></a>响应事件</h4><p><code>http.ServerResponse</code>继承自<code>EventEmitter</code>,而不是<code>Writable Stream</code>.其支持的事件不多,包括 close,finish,error 等.HTTP 本身是无状态的,一次请求只需要响应一次,所以响应后请求就会被销毁.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  req.on(<span class="string">&quot;error&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">    res.statusCode = <span class="number">400</span>;</span><br><span class="line">    res.end();</span><br><span class="line">  &#125;);</span><br><span class="line">  res.on(<span class="string">&quot;error&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">if</span> (req.method === <span class="string">&quot;GET&quot;</span> &amp;&amp; req.url === <span class="string">&quot;/echo&quot;</span>) &#123;</span><br><span class="line">    req.pipe(res);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.statusCode = <span class="number">404</span>;</span><br><span class="line">    res.end();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3002</span>, <span class="function">() =&gt;</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Server running at http://127.0.0.1:<span class="subst">$&#123;app.address().port&#125;</span>`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="http-Server-事件"><a href="#http-Server-事件" class="headerlink" title="http.Server 事件"></a>http.Server 事件</h4><p>http.Server 类继承自 net.Server 类,除了支持 req 事件和 res 事件,还支持 Server 类事件,例如文档中常见的 checkContinue, checkExpectation, clientError, close, connect, connection, request, upgrade 等.request 事件是用来拦截经过服务器处理的所有请求响应信息的,如果想记录或拦截请求信息,可以采用如下方式.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;req.method&#125;</span> <span class="subst">$&#123;req.url&#125;</span>`</span>);</span><br><span class="line">  <span class="comment">// 设置响应状态码和Headers</span></span><br><span class="line">  res.writeHead(<span class="number">200</span>, &#123; <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/plain&quot;</span> &#125;);</span><br><span class="line">  res.end(<span class="string">&quot;Hello Node\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">&quot;request&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 事件处理</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3002</span>, <span class="function">() =&gt;</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Server running at http://127.0.0.1:<span class="subst">$&#123;app.address().port&#125;</span>`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="HTTP-模块源码"><a href="#HTTP-模块源码" class="headerlink" title="HTTP 模块源码"></a>HTTP 模块源码</h4><p>Node.js 源码中和 HTTP 相关的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">❯ ls -a lib | grep http</span><br><span class="line"></span><br><span class="line">_http_agent.js</span><br><span class="line">_http_client.js</span><br><span class="line">_http_common.js</span><br><span class="line">_http_incoming.js</span><br><span class="line">_http_outgoing.js</span><br><span class="line">_http_server.js</span><br><span class="line">http.js</span><br><span class="line">http2.js</span><br><span class="line">https.js</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">文件</th>
<th align="center">内容</th>
<th align="center">功能描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">_http_common.js</td>
<td align="center">用户向服务器发送的消息</td>
<td align="center">请求</td>
</tr>
<tr>
<td align="center">_http_outgoing.js</td>
<td align="center">服务器向用户发送的消息</td>
<td align="center">响应</td>
</tr>
<tr>
<td align="center">_http_client.js</td>
<td align="center">客户端向服务器发送 incoming 消息</td>
<td align="center">访问 HTTP 服务</td>
</tr>
<tr>
<td align="center">_http_server.js</td>
<td align="center">服务器端实现</td>
<td align="center">提供 HTTP 服务</td>
</tr>
<tr>
<td align="center">http.js</td>
<td align="center">核心模块</td>
<td align="center">对外暴露 API</td>
</tr>
</tbody></table>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>HTTPS(Hyper Text Transfer Protocol over Secure Socket Layer)是以安全目标为 HTTP 通道.HTTPS 在网络传输过程中主要使用 SSL/TLS 进行加密</p>
<ul>
<li>SSL: Secure Socket Layer,安全套接字层,是位于可靠的面向连接的网络协议层和应用协议层之间的一种协议层.SSL 通过互相认证,使用数字签名确保完整性,使用加密确保私密性,以实现客户端和服务器端的通信安全.SSL 由两部分组成,分别是 SSL 记录协议和 SSL 握手协议</li>
<li>TLS: Transport Layer Security, 安全传输层协议,用以保证两个应用程序之间的保密性和数据完整性.该协议由两部分组成,分别是 TLS 记录协议和 TLS 握手协议</li>
</ul>
<h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><p>以 Let’s Encrypr 为例，在终端安装 acme.sh 脚本，完成以下步骤便获得了 cronjob 定时任务, 每天 0 点自动检测所有证书,所有的修改都限制在(<code>~/.acme.sh/</code>)中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl https://get.acme.sh | sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个bash的<span class="built_in">alias</span></span></span><br><span class="line">alias acme.sh=~/.acme.sh/acme.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证HTTPS是否生效,添加TXT解析规则</span></span><br><span class="line">acme.sh --issue -d wzy.monster --dns \</span><br><span class="line"> --yes-I-know-dns-manual-mode-enough-go-ahead-please</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新验证</span></span><br><span class="line">acme.sh --renew -d wzy.monster --dns \</span><br><span class="line"> --yes-I-know-dns-manual-mode-enough-go-ahead-please</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用证书"><a href="#使用证书" class="headerlink" title="使用证书"></a>使用证书</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">&#x27;https&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> body = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hskey = fs.readFileSync(<span class="string">&#x27;/home/hqwuzhaoyi/.acme.sh/wzy.monster/wzy.monster.key&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> hscert = fs.readFileSync(<span class="string">&#x27;/home/hqwuzhaoyi/.acme.sh/wzy.monster/fullchain.cer&#x27;</span>)</span><br><span class="line"></span><br><span class="line">https.createServer(options, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.writeHead(<span class="number">200</span>);</span><br><span class="line">  res.end(<span class="string">&#x27;hello world\n&#x27;</span>);</span><br><span class="line">&#125;).listen(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="HSTS"><a href="#HSTS" class="headerlink" title="HSTS"></a>HSTS</h3><p>HTTP Strict Transport Security</p>
<p>强制客户端使用 HTTPS 与服务器创建连接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">&#x27;helmet&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">app.use(helmet.hsts(&#123;</span><br><span class="line">  maxAge: <span class="number">31536000000</span>,</span><br><span class="line">  includeSubdomains: <span class="literal">true</span>,</span><br><span class="line">  force: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<h3 id="Nginx-HTTPS-配置"><a href="#Nginx-HTTPS-配置" class="headerlink" title="Nginx HTTPS 配置"></a>Nginx HTTPS 配置</h3><p>首先保证 Nginx 的 HTTPS 配置正常,生成 Diffie-Hellman Group,基于 DH 的 SSL 握手,不同于 RSA 的 SSL 握手</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/sites-available/wzy.monster</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">server_name...</span><br><span class="line"></span><br><span class="line">ssl_certificate         /home/hqwuzhaoyi/.acme.sh/wzy.monster/fullchain.cer</span><br><span class="line">ssl_certificate_key     /home/hqwuzhaoyi/.acme.sh/wzy.monster/wzy.monster.key</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>启用更安全的 SSL 协议及 Ciphers</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE</span><br><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">ssl_dhparam /etc/ssl/certs/dhparam.pem;</span><br><span class="line">ssl_ciphers HIGH:!aNULL:!eNULL:!MD5:!RC4:!DES:!PSK:!EXPORT:!SHA:!SHA256;</span><br><span class="line"></span><br><span class="line">ssl_session_timeout 5m;</span><br><span class="line">ssl_session_cache shared:SSL:10m;</span><br><span class="line">ssl_stapling on;</span><br><span class="line">ssl_stapling_verify on;</span><br><span class="line">add_header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains&quot; always;</span><br><span class="line">#add_header Strict-Transport-Security max-age=15768000;</span><br></pre></td></tr></table></figure>

<p>重定向非 HTTPS 请求</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/sites-available/wzy.monster</span><br><span class="line"></span><br><span class="line">return 301 https://$host$request_uri;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<h2 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h2><p>可以使用<br><a target="_blank" rel="noopener" href="http://hiproxy.org/zh-cn/get_started/index.html">hiproxy</a></p>
<h1 id="Koa"><a href="#Koa" class="headerlink" title="Koa"></a>Koa</h1><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="parseurl"><a href="#parseurl" class="headerlink" title="parseurl"></a>parseurl</h3><p>专门用来解析 URL 地址</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createReq</span> (<span class="params">url, originalUrl</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        originalUrl: originalUrl,</span><br><span class="line">        url: url</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> req = createReq(<span class="string">&#x27;https://127.0.0.1:8080/site/oneway_list.htm?a=1&amp;b=2#abc&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&#x27;parseurl&#x27;</span>)(req)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(url)</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Url &#123;</span><br><span class="line">  protocol: &#x27;https:&#x27;,</span><br><span class="line">  slashes: true,</span><br><span class="line">  auth: null,</span><br><span class="line">  host: &#x27;127.0.0.1:8080&#x27;,</span><br><span class="line">  port: &#x27;8080&#x27;,</span><br><span class="line">  hostname: &#x27;127.0.0.1&#x27;,</span><br><span class="line">  hash: &#x27;#abc&#x27;,</span><br><span class="line">  search: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class="line">  query: &#x27;a=1&amp;b=2&#x27;,</span><br><span class="line">  pathname: &#x27;/site/oneway_list.htm&#x27;,</span><br><span class="line">  path: &#x27;/site/oneway_list.htm?a=1&amp;b=2&#x27;,</span><br><span class="line">  href: &#x27;https://127.0.0.1:8080/site/oneway_list.htm?a=1&amp;b=2#abc&#x27;,</span><br><span class="line">  _raw: &#x27;https://127.0.0.1:8080/site/oneway_list.htm?a=1&amp;b=2#abc&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th>对应的 Koa 获取方式</th>
</tr>
</thead>
<tbody><tr>
<td>protocol</td>
<td>该协议部分为 http:</td>
<td>ctx.protocol</td>
</tr>
<tr>
<td>slashes</td>
<td>用于判断是否使用//作为分隔符</td>
<td>无</td>
</tr>
<tr>
<td>auth</td>
<td>与授权有关，绝大部分时间不会用到</td>
<td>无</td>
</tr>
<tr>
<td>host</td>
<td>由 hostname 和 port 组成</td>
<td>ctx.host</td>
</tr>
<tr>
<td>port</td>
<td>服务器对应的端口号，默认 80</td>
<td>无</td>
</tr>
<tr>
<td>hostname</td>
<td>服务器对应的域名或 ip 地址</td>
<td>ctx.hostname</td>
</tr>
<tr>
<td>hash</td>
<td>字符串，URL 的锚部分,对应 location.hash</td>
<td>无</td>
</tr>
<tr>
<td>search</td>
<td>搜索部分，可以有多个参数，参数与参数之间通过&amp;分割</td>
<td>ctx.search</td>
</tr>
<tr>
<td>query</td>
<td>查询字符串</td>
<td>ctx.query</td>
</tr>
<tr>
<td>pathname</td>
<td>从域名的最后一个/开始到?为止，是文件名部分，文件民部分不是一个 URL 必须有的部分，如果省略该部分，则使用默认的文件名</td>
<td>无</td>
</tr>
<tr>
<td>path</td>
<td>由 pathname 和 search 组成</td>
<td>ctx.path</td>
</tr>
<tr>
<td>href</td>
<td>完整的 URL 上面能有的都包含</td>
<td>ctx.href</td>
</tr>
</tbody></table>
<p>在 Koa 中对应如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx=&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> ctx.body = &#123;</span><br><span class="line">        href: ctx.href</span><br><span class="line">        ,<span class="attr">path</span> : ctx.path</span><br><span class="line">        ,<span class="attr">url</span> : ctx.url</span><br><span class="line">        ,<span class="attr">query</span> : ctx.query</span><br><span class="line">        ,<span class="attr">querystring</span> : ctx.querystring</span><br><span class="line">        ,<span class="attr">search</span> : ctx.search</span><br><span class="line">        ,<span class="attr">host</span> : ctx.host</span><br><span class="line">        ,<span class="attr">hostname</span> : ctx.hostname</span><br><span class="line">        ,<span class="attr">protocol</span> : ctx.protocol</span><br><span class="line">        ,<span class="attr">secure</span> : ctx.secure</span><br><span class="line">        ,<span class="attr">subdomains</span> : ctx.subdomains</span><br><span class="line">        ,<span class="attr">origin</span> : ctx.origin</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;href&quot;</span>: <span class="string">&quot;http://localhost:3000/site/oneway_list.htm?a=1&amp;b=2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/site/oneway_list.htm&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;/site/oneway_list.htm?a=1&amp;b=2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;a&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;b&quot;</span>: <span class="string">&quot;2&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;querystring&quot;</span>: <span class="string">&quot;a=1&amp;b=2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;search&quot;</span>: <span class="string">&quot;?a=1&amp;b=2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;host&quot;</span>: <span class="string">&quot;localhost:3000&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;secure&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;subdomains&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;origin&quot;</span>: <span class="string">&quot;http://localhost:3000&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>像 hash,port 这样的字段在 ctx.request 中都没有体现，可以通过 parseurl 绑定到 ctx 上</p>
<h3 id="HTTP-头部"><a href="#HTTP-头部" class="headerlink" title="HTTP 头部"></a>HTTP 头部</h3><p>HTTP 采用了请求响应模型，网络资源传输的内容包括 message-header 和 message-body 两部分，首先传输的是 message-header，即头部消息。在 RFC 2616 中，HTTP 头部消息通常被分为 4 个部分:general header,request header,response header,entity header</p>
<ul>
<li><code>ctx.header</code>获取全部头部信息</li>
<li><code>ctx.get获取特定的头部信息</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">get_cache_control: ctx.get(<span class="string">&#x27;Cache-Control&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;get_cache_control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span></span><br></pre></td></tr></table></figure>

<p>还有其他不常见但有实际应用的</p>
<ul>
<li>charset: 用于获取字符集</li>
<li>length: 用于获取 Content-Length 长度</li>
<li>accepts： 表示客户端可以接受的媒体类型</li>
<li>acceptsEncoding: 表示支持的压缩算法</li>
<li>accpetsCharsets: 表示支持的字符集</li>
<li>accpetsLanguages: 表示支持的语言</li>
<li>is: 用于判断请求中的 Content-Type 值与预期是否一致</li>
<li>type: 用于获取或设置 Content-Type 值</li>
</ul>
<p>游览器并非完整的将内容保存在本地，Chrome 会将缓存的文件保存在一个名为 User Data 的文件夹下，服务器端会和客户端约定一个有效期。</p>
<p>首先，使用 cache-control 判断是否有缓存，如果有缓存且缓存没有过期，就直接读取缓存并呈现。如果缓存已过期，就检测 Etag 值。响应头中的 Etag 表示资源的版本，游览器在发送请求时会自动附带名为 If-None-Match 的请求头字段来询问 Web 服务器该资源版本是否仍然可用。如果服务器发现该资源的版本仍然是最新的，就返回 304 状态码指示游览器继续使用缓存呈现，否则要返回 200 状态码并向 Web 服务器发起请求，协商缓存流程</p>
<h3 id="http-状态码"><a href="#http-状态码" class="headerlink" title="http 状态码"></a>http 状态码</h3><p>ctx.status = ctx.response.status</p>
<ul>
<li>500 Internet Server Error</li>
<li>Forbidden</li>
<li>Not Found</li>
<li>Not Modified</li>
<li>OK</li>
</ul>
<h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><p>Cookie 是在 HTTP 下，服务器或脚本维护客户工作站上存在的一种信息形式。无论何时，只要用户连接到服务器，Web 站点就可以访问 Cookie 信息。</p>
<p>服务器端向客户端发送 Cookie，客户端的游览器把 Cookie 保存起来，然后在每次请求游览器时将 Cookie 发送到服务器端，在 HTML 文档被发送之前，Web 服务器会通过传送 HTTP 包头中的 Set-Cookie 消息把一个 Cookie 发送到用户的游览器中。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: koa.sid=BypBuJromdMeagLH19TbFKh3nxvHoOah; path=/; expires=Wed, 24 Jan 2018 06:44:28 GMT; httponly</span><br></pre></td></tr></table></figure>

<ul>
<li>name=value: 在 Cookie 中可以用这种方式对内容赋值</li>
<li>maxAge: 最大失效事件 ms</li>
<li>signed: Cookie 值签名</li>
<li>path: Cookie 影响到的路径。如果路径不能匹配，游览器就不发送这个 Cookie</li>
<li>domain: Cookie 影响到的域名</li>
<li>secure: 值为 true 时，表示 Cookie 在 HTTP 中是无效的，在 HTTPS 中才有效</li>
<li>httpOnly: 微软对 Cookie 做的扩展，如果 Cookie 中设置了 httpOnly,则将无法通过程序读取到 Cookie 信息，这样可以防止 XSS 攻击产生。</li>
<li>Expires: 缓存失效时间。</li>
</ul>
<h4 id="在-Node-js-中，Cookie-是通过-response-writeHead-被写入的，代码如下"><a href="#在-Node-js-中，Cookie-是通过-response-writeHead-被写入的，代码如下" class="headerlink" title="在 Node.js 中，Cookie 是通过 response.writeHead 被写入的，代码如下"></a>在 Node.js 中，Cookie 是通过 response.writeHead 被写入的，代码如下</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置过期时间为1min</span></span><br><span class="line"><span class="keyword">var</span> today = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line"><span class="keyword">var</span> time = today.getTime() + <span class="number">60</span>*<span class="number">1000</span></span><br><span class="line"><span class="keyword">var</span> time2 = <span class="keyword">new</span> <span class="built_in">Date</span>(time)</span><br><span class="line"><span class="keyword">var</span> timeObj = time2.toGMTString()</span><br><span class="line"></span><br><span class="line">response.writeHead(&#123;</span><br><span class="line">  <span class="string">&#x27;Set-Cookie&#x27;</span>: <span class="string">&#x27;myCookie=&quot;type=koa&quot;, &quot;language=javascript&quot;;path=&quot;/&quot;;</span></span><br><span class="line"><span class="string">  Expires=&#x27;</span> + timeObj + <span class="string">&#x27;;httpOnly=true&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="使用-Koa-写入-Cookie"><a href="#使用-Koa-写入-Cookie" class="headerlink" title="使用 Koa 写入 Cookie"></a>使用 Koa 写入 Cookie</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.cookies.set(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;koasj&#x27;</span>, &#123; <span class="attr">signed</span>: <span class="literal">true</span> &#125;)</span><br></pre></td></tr></table></figure>

<p>查看源码，Koa 和 Express 中都使用了 cookies 模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Cookies = <span class="built_in">require</span>(<span class="string">&#x27;cookies&#x27;</span>)</span><br><span class="line">context.cookies = <span class="keyword">new</span> Cookies(req, res, &#123;</span><br><span class="line">  keys: <span class="built_in">this</span>.keys,</span><br><span class="line">  secure: req.secure</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>req.secure 的意思是采用安全协议，可以理解为 ctx.protocol 的值是 https。另外，app.keys 是用于让 Cookie 进行签名的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.keys = [<span class="string">&#x27;im a newer secret&#x27;</span>, <span class="string">&#x27;i like turtle&#x27;</span>]</span><br><span class="line">app.keys = <span class="keyword">new</span> KeyGrip([<span class="string">&#x27;im a newer secret&#x27;</span>, <span class="string">&#x27;i like turtle&#x27;</span>], <span class="string">&#x27;sha256&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="获取参数的三种不同方法"><a href="#获取参数的三种不同方法" class="headerlink" title="获取参数的三种不同方法"></a>获取参数的三种不同方法</h2><table>
<thead>
<tr>
<th>参数名称</th>
<th>描述</th>
<th>Express 中的获取方法</th>
<th>Koa 中的获取方法</th>
<th>依赖模块</th>
</tr>
</thead>
<tbody><tr>
<td>params</td>
<td>具名参数，如/user/:id</td>
<td>req.params</td>
<td>ctx.params</td>
<td>Koa 需要依赖 koa-router，而 Express 中有内置路由，无需依赖</td>
</tr>
<tr>
<td>query</td>
<td>查询字符串</td>
<td>req.query</td>
<td>ctx.query</td>
<td>内置，无需依赖</td>
</tr>
<tr>
<td>body</td>
<td>请求体，带有 body 请求的 POST 类中的 body 内容</td>
<td>req.body</td>
<td>ctx.request.body</td>
<td>Express 依赖 bodyparser 模块，Koa 依赖 koa-bodyparser 模块</td>
</tr>
</tbody></table>
<h3 id="获取具名参数-params"><a href="#获取具名参数-params" class="headerlink" title="获取具名参数 params"></a>获取具名参数 params</h3><p>koa-router 内置了 ctx.params</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/:id&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ctx.params)</span><br><span class="line">    ctx.body = <span class="string">&#x27;show your id = &#x27;</span> + ctx.params.id</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="解析请求体-body"><a href="#解析请求体-body" class="headerlink" title="解析请求体 body"></a>解析请求体 body</h3><p>在 HTTP 请求中， POST、PUT 和 PATCH 类的请求方法中包含请求体，需要要单独处理，在 Node.js 原生的 http 模块中，请求体要基于流的方式接收和解析。</p>
<p>body-praser 是一个 HTTP 请求体解析的中间件可用于解析 JSON, Raw, 文本, URL-encoded 等格式的请求体，也是 Express 框架中的请求体解析中间件。在 Koa 中， body-parser 对应的中间件是 koa-bodyparser，且 koa-bodyparser 的用法更简单。如果包含 key-value 的数据实在请求体里被提交给服务器的，koa-bodyparser 默认值是 undefined，只有通过 bodyparser 进行解析才能正常使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bodyparser = <span class="built_in">require</span>(<span class="string">&#x27;koa-bodyparser&#x27;</span>)()</span><br><span class="line"></span><br><span class="line">app.use(bodyparser)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/post&#x27;</span>, <span class="function">(<span class="params">ctx, netx</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.body = ctx.request.body</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -d &quot;a=1&quot; http://127.0.0.1:3000/post</span><br><span class="line"></span><br><span class="line">&#123;&quot;a&quot;:&quot;1&quot;&#125;#</span><br></pre></td></tr></table></figure>

<h3 id="获取查询字符串-query"><a href="#获取查询字符串-query" class="headerlink" title="获取查询字符串 query"></a>获取查询字符串 query</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// GET /search?q=tobi+ferret</span><br><span class="line">ctx.query.q</span><br><span class="line">// =&gt; &quot;tobi ferret&quot;</span><br><span class="line"></span><br><span class="line">// GET /shoes?order=desc&amp;shoe[color]=blue&amp;shoe[type]=converse</span><br><span class="line">curl http://127.0.0.1:3000/shoes\?order\=desc\&amp;shoe\[color\]\=blue\&amp;shoe\[type\]\=converse</span><br><span class="line">ctx.query.order</span><br><span class="line">// =&gt; &quot;desc&quot;</span><br><span class="line"></span><br><span class="line">// POST /search&gt;q=tobi+ferrect</span><br><span class="line">&#123;a:1, b:2&#125;</span><br><span class="line">ctx.query.q</span><br><span class="line">// =&gt; &quot;tobi ferrect&quot;</span><br></pre></td></tr></table></figure>

<p>POST 请求也可以使用查询字符串 query</p>
<h2 id="body-解析"><a href="#body-解析" class="headerlink" title="body 解析"></a>body 解析</h2><h3 id="模块依赖"><a href="#模块依赖" class="headerlink" title="模块依赖"></a>模块依赖</h3><table>
<thead>
<tr>
<th>模块</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>koa-bodyparser</td>
<td>Koa 中间件,及处理配置的类型</td>
</tr>
<tr>
<td>co-body</td>
<td>使用 co 封装,用于获取请求内的 body 内容,是 koa-bodyparser 的核心依赖模块,主要对 HTTP 里的 req 进行处理,如果想定制特殊功能,使用 co-body 模块是非常好的选择</td>
</tr>
<tr>
<td>stream-utils,raw-body</td>
<td>从请求中获取 raw body,是 co-body 的依赖模块</td>
</tr>
</tbody></table>
<h3 id="表单类型列表"><a href="#表单类型列表" class="headerlink" title="表单类型列表"></a>表单类型列表</h3><p>在 HTTP 请求头里,有些 HTTP 动词会带有 message-body,比如 POST,PATCH,DELETE 等,针使用这些动词的请求,我们需根据不同的 Content-Type 来返回 body.常用的处理方式如表</p>
<table>
<thead>
<tr>
<th>表单提交类型</th>
<th>Content-Type</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>JSON 数据</td>
<td>application/json, application/json-patch+json, application/vnd.api+json, application/csp-report</td>
<td>使用 RESTful JSON API 接口设计</td>
</tr>
<tr>
<td>form 表单</td>
<td>application/x-www-form-urlencoded</td>
<td>常见的表单交互方式</td>
</tr>
<tr>
<td>text 文本</td>
<td>text/plain</td>
<td>不常用,特定场景会用</td>
</tr>
</tbody></table>
<p>Koa 通过 ctx.body 向游览器写入响应,而 ctx 上用了 body 关键字,所以只能通过 ctx.request.body 来处理请求体.</p>
<h3 id="常见的-POST"><a href="#常见的-POST" class="headerlink" title="常见的 POST"></a>常见的 POST</h3><h4 id="JSON-类型"><a href="#JSON-类型" class="headerlink" title="JSON 类型"></a>JSON 类型</h4><p>koa-bodyparser 默认配置是启动 JSON 支持,所以只要在请求之前添加这个中间件就行</p>
<h3 id="表单类型"><a href="#表单类型" class="headerlink" title="表单类型"></a>表单类型</h3><h4 id="通用表单处理-form-data"><a href="#通用表单处理-form-data" class="headerlink" title="通用表单处理 form-data"></a>通用表单处理 form-data</h4><p>通用表单处理指的是 form-data，其主要依赖两个模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --save koa-bodyparser // 解析body内容</span><br><span class="line">npm install --save koa  // 文件上传</span><br></pre></td></tr></table></figure>

<p>在 app.js 中启用 bodyparser 的可用类型，这种情况下默认支持 form</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.use(bodyparser(&#123;</span><br><span class="line">  enableTypes: [<span class="string">&#x27;json&#x27;</span>,<span class="string">&#x27;form&#x27;</span>]</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<p>koa-multer 是一个非常便于使用的文件上传模块，使用 koa-multer 可以解析 body 中的流，并将其保存成文件，使用方法如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&#x27;koa-multer&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> upload = multer(&#123;<span class="attr">dest</span>: <span class="string">&#x27;uploads/&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>koa-multer 的用法非常简单，只需把 upload 内置的中间件挂载到路由上即可，这里使用 upload.any()方法，不限制表单字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/post/formdata&#x27;</span>, upload.any(), <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(ctx.req.files)</span><br><span class="line">  ctx.body = &#123;</span><br><span class="line">    status: &#123;</span><br><span class="line">      code: <span class="number">0</span>,</span><br><span class="line">      msg: <span class="string">&#x27;upload sucess&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    data: &#123;</span><br><span class="line">      body: ctx.req.body,</span><br><span class="line">      files: ctx.req.files</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>koa-multer 不会处理 multipart/form-data 以外的任何表单。</p>
<h4 id="普通表单-x-www-form-ulrlencoded"><a href="#普通表单-x-www-form-ulrlencoded" class="headerlink" title="普通表单 x-www-form-ulrlencoded"></a>普通表单 x-www-form-ulrlencoded</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/post&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(ctx.request.body)</span><br><span class="line">  ctx.body = ctx.request.body</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&#x27;koa-multer&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> upload = multer(&#123;<span class="attr">dest</span>: <span class="string">&#x27;uploads/&#x27;</span>&#125;)</span><br><span class="line">router.prefix(<span class="string">&#x27;/upload&#x27;</span>)</span><br><span class="line">router.post(<span class="string">&#x27;/&#x27;</span>, upload.any(), <span class="function">(<span class="params">ctx, netx</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">        status: &#123;</span><br><span class="line">            code: <span class="number">0</span>,</span><br><span class="line">            msg: <span class="string">&#x27;upload success&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        data: &#123;</span><br><span class="line">            body: ctx.req.files</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>将 multer 的上传目录配置为根部录下的 uploads 目录</li>
<li>upload 变量上的函数有 array, singgle, fields 等， 这些函数均可用来处理文件上传</li>
<li>multer 的原始做法是通过 ctx.req.files 来获取上传的文件，然后对 api 进行调整</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">❯ curl -F &#x27;avatar=@&quot;test.png&quot;&#x27; -F &#x27;a=1&#x27; -F &#x27;b=2&#x27; http://127.0.0.1:3000/upload/</span><br><span class="line"></span><br><span class="line">&#123;&quot;status&quot;:&#123;&quot;code&quot;:0,&quot;msg&quot;:&quot;upload success&quot;&#125;,&quot;data&quot;:&#123;&quot;body&quot;:[&#123;&quot;fieldname&quot;:&quot;avatar&quot;,&quot;originalname&quot;:&quot;test.png&quot;,&quot;encoding&quot;:&quot;7bit&quot;,&quot;mimetype&quot;:&quot;image/png&quot;,&quot;destination&quot;:&quot;uploads/&quot;,&quot;filename&quot;:&quot;92e76c339ace7fcfb1e10ef126ad8617&quot;,&quot;path</span><br><span class="line">&quot;:&quot;uploads/92e76c339ace7fcfb1e10ef126ad8617&quot;,&quot;size&quot;:6582&#125;]&#125;&#125;#</span><br></pre></td></tr></table></figure>

<h3 id="文本类型-text-plain"><a href="#文本类型-text-plain" class="headerlink" title="文本类型 text/plain"></a>文本类型 text/plain</h3><p>bodyparser 默认支持的是 form 和 JSON 两种格式的解析，当出现 Content-Type:”text/plain”的时候是无法进行处理的，所以这时候需要在 koa-bodyparser 中开启 text 支持</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.use(bodyparser(&#123;</span><br><span class="line">  enableTypes: [<span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;form&#x27;</span>, <span class="string">&#x27;text&#x27;</span></span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<p>在 Postman 中，所选类型为 raw</p>
<h3 id="HTTP-模块"><a href="#HTTP-模块" class="headerlink" title="HTTP 模块"></a>HTTP 模块</h3><table>
<thead>
<tr>
<th>模块名称</th>
<th>是否支持游览器</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>request</td>
<td>否</td>
<td>Node.js 里使用最广泛的模块之一</td>
</tr>
<tr>
<td>superagent</td>
<td>是 IE10 及以上版本，使用 IE9 需要打补丁</td>
<td>Node.js 里最好用的模块，其 API 使用起来最便捷，而且为 supertest 的核心模块</td>
</tr>
<tr>
<td>got</td>
<td>否</td>
<td>极简模块，可以满足绝大部分场景需求</td>
</tr>
<tr>
<td>node-fetch</td>
<td>否，担忧对应的游览器版的 fetch，规范相同</td>
<td>尤其适合 API 请求，在 axios 之前，React 等都是使用 fetch 模块的</td>
</tr>
<tr>
<td>axios</td>
<td>是</td>
<td>同时支持游览器和 Node.js 的模块，和 fetch 一样尤其适合用 API 请求，目前在 Reach 和 Vue 中使用极其广泛</td>
</tr>
</tbody></table>
<h4 id="request"><a href="#request" class="headerlink" title="request"></a>request</h4><p>功能十分强大，还有 request-promise 支持 Promise</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -S request</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">&#x27;request&#x27;</span>)</span><br><span class="line"></span><br><span class="line">request.post(&#123;</span><br><span class="line">    url: <span class="string">&#x27;http://127.0.0.1:3000/&#x27;</span>,</span><br><span class="line">    form: &#123;</span><br><span class="line">        username: <span class="string">&#x27;yourUsername&#x27;</span>,</span><br><span class="line">        password: <span class="string">&#x27;yourPassword&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="function">(<span class="params">err, httpResponse, body</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="built_in">console</span>.log(err)</span><br><span class="line">    <span class="built_in">console</span>.log(body)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="superagent"><a href="#superagent" class="headerlink" title="superagent"></a>superagent</h4><p>superagent 是一个轻量级 Node.js 模块，可读性好，设计人性化，有大量插件，推荐！</p>
<p>superagent 也是著名的测速模块 supertest 的基础模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ npm i -S superagent</span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">&#x27;superagent&#x27;</span>)</span><br><span class="line"></span><br><span class="line">request</span><br><span class="line">    .post(<span class="string">&#x27;http://127.0.0.1:3000/users/post&#x27;</span>)</span><br><span class="line">    .send(&#123;</span><br><span class="line">        username: <span class="string">&#x27;yourUsername&#x27;</span>,</span><br><span class="line">        password: <span class="string">&#x27;yourPassword&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span>(<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.body)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="got"><a href="#got" class="headerlink" title="got"></a>got</h4><p>request 过于复杂，Sindre Sorhus 开发了这个更简单易用。</p>
<h4 id="node-fetch"><a href="#node-fetch" class="headerlink" title="node-fetch"></a>node-fetch</h4><p>优雅，同时兼容 Node.js 和 Browser</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">&#x27;node-fetch&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fetch(<span class="string">&#x27;http://127.0.0.1:3000/users/post&#x27;</span>, &#123;</span><br><span class="line">    method: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">        username: <span class="string">&#x27;yourUsername&#x27;</span>,</span><br><span class="line">        password: <span class="string">&#x27;yourPassword&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> res.json();</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">json</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(json)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="axios"><a href="#axios" class="headerlink" title="axios"></a>axios</h4><p>和 fetch 类似，主流</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"></span><br><span class="line">axios.defaults.baseURL = <span class="string">&#x27;http://127.0.0.1:3000&#x27;</span></span><br><span class="line"></span><br><span class="line">axios.post(<span class="string">&#x27;/users/post&#x27;</span>, &#123;</span><br><span class="line">    username: <span class="string">&#x27;yourUsername&#x27;</span>,</span><br><span class="line">    password: <span class="string">&#x27;yourPassword&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(response.data)</span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="API-开发"><a href="#API-开发" class="headerlink" title="API 开发"></a>API 开发</h2><h3 id="koa-res-api"><a href="#koa-res-api" class="headerlink" title="koa.res.api"></a><code>koa.res.api</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -S koa.res.api</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">var</span> res_api = <span class="built_in">require</span>(<span class="string">&#x27;koa.res.api&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.use(res_api())</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接返回API接口</span></span><br><span class="line">ctx.api(<span class="number">404</span>, err, &#123;</span><br><span class="line">  code: <span class="number">1</span>,</span><br><span class="line">  msg: <span class="string">&#x27;delete failed&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回带有状态的JSON数据</span></span><br><span class="line">ctx.api(data, &#123;</span><br><span class="line">  code: <span class="number">1</span>,</span><br><span class="line">  msg: <span class="string">&#x27;delete failed&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回JSON API</span></span><br><span class="line">ctx.api(data)</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回有异常情况下返回错误结果</span></span><br><span class="line">ctx.api_error(err)</span><br></pre></td></tr></table></figure>

<h3 id="响应处理"><a href="#响应处理" class="headerlink" title="响应处理"></a>响应处理</h3><p>因为 JS 为动态语言，常会抛出 Uncaught TypeError 类的异常，做响应处理是非常重要的内容</p>
<h4 id="Loadsh"><a href="#Loadsh" class="headerlink" title="Loadsh"></a>Loadsh</h4><p>使用 Lodash 的_get 方法，根据路径获取值，如果获取的值是 undefined，则会赋予解析结果以默认值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">&#x27;loadsh&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> object = &#123;<span class="attr">a</span>: [&#123;<span class="attr">b</span>: &#123;<span class="attr">c</span>: <span class="number">3</span>&#125;&#125;]&#125;;</span><br><span class="line"><span class="keyword">const</span> c = _.get(object, <span class="string">&#x27;a[0].b.c&#x27;</span>,<span class="number">1</span>) <span class="comment">// 默认值为1</span></span><br><span class="line"><span class="keyword">const</span> d = _.get(object, <span class="string">&#x27;a[0].b.d&#x27;</span>,<span class="number">1</span>) <span class="comment">// 默认值为1</span></span><br><span class="line"><span class="built_in">console</span>.log(c)  <span class="comment">// 3</span></span><br><span class="line"><span class="built_in">console</span>.log(d)  <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>

<h4 id="TypeScript"><a href="#TypeScript" class="headerlink" title="TypeScript"></a>TypeScript</h4><p><code>tsc.ts --strictNullChecks</code> 启用新的严格空值检查模式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tsc.ts</span></span><br><span class="line"></span><br><span class="line">interface User &#123;</span><br><span class="line">    name: <span class="built_in">String</span>,</span><br><span class="line">    age?: number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printUserInfo</span>(<span class="params">user: User</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;user.name&#125;</span>, <span class="subst">$&#123;user.age.toString()&#125;</span>`</span>)</span><br><span class="line">    <span class="comment">//  error TS2532: Object is possibly &#x27;undefined&#x27;.</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;user.name&#125;</span>, <span class="subst">$&#123;user.age!.toString()&#125;</span>`</span>)</span><br><span class="line">    <span class="comment">// OK, you confirm that you&#x27;re sure user.age is non-null</span></span><br><span class="line">    <span class="keyword">if</span> (user.age != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;user.name&#125;</span>, <span class="subst">$&#123;user.age.toString&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// OK, the if-condition checked that user.age is non-null</span></span><br><span class="line">    <span class="built_in">console</span>.log(user.name+<span class="string">&#x27;,&#x27;</span>+user.age != <span class="literal">null</span> ? user.age.toString() : <span class="string">&#x27;age unknown&#x27;</span>)</span><br><span class="line">    <span class="comment">// error TS2532: Object is possibly &#x27;undefined&#x27;.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h4><table>
<thead>
<tr>
<th align="center">API 方式</th>
<th align="center">说明</th>
<th align="center">难度</th>
<th align="center">例子</th>
</tr>
</thead>
<tbody><tr>
<td align="center">简单 API</td>
<td align="center">直接返回 JSON 数据，只对返回数据结果做约定，遵循基本的接口规范，开发随意一些</td>
<td align="center">小</td>
<td align="center">非常的，不具体举例</td>
</tr>
<tr>
<td align="center">RESTful API</td>
<td align="center">遵循统一的标准，非常容易量产和验收</td>
<td align="center">大</td>
<td align="center">GithHub 开发 API 的 v3 版本</td>
</tr>
<tr>
<td align="center">GraphQL</td>
<td align="center">Facebook 提出的应用层查询语言，类似 API 中间层，可以模拟 API，也可以借助 Apollo 实现一些服务器端功能</td>
<td align="center">大</td>
<td align="center">GitHub 开放 APIdv3 版本</td>
</tr>
</tbody></table>
<h4 id="API-访问鉴权"><a href="#API-访问鉴权" class="headerlink" title="API 访问鉴权"></a>API 访问鉴权</h4><h5 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h5><p>目前流行的鉴权方式有两种：JSON Web Tokens(JWT), OAuth</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> secret = <span class="string">&#x27;17koa.com&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> token = jwt.sign(&#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">        user_id: <span class="number">100000</span>,</span><br><span class="line">        user_name: <span class="string">&#x27;i5ting&#x27;</span>,</span><br><span class="line">        user_email: <span class="string">&#x27;i5ting@126.com&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, secret, &#123; <span class="attr">expiresIn</span>: <span class="string">&#x27;1h&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// invalid token - synchronous</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> decoded = jwt.verify(token, secret);</span><br><span class="line">    <span class="built_in">console</span>.log(decoded)</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="comment">// err</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>客户端申请令牌时，使用 jwt.sign 进行签名，并将签名结果返回客户端</li>
<li>签名体 payload 会包含用户的必要信息，以便通过 jwt.verify 进行校验时能获得该信息，作为豁免的查询依据</li>
<li>当 API 请求携带令牌时，需要先使用 jwt.verify 进行校验，成功后才能根据用户信息查询并返回数据</li>
</ul>
<p>客户端该怎么把令牌传给服务器呢，以下是一种方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查POST的信息，URL查询参数，头部信息</span></span><br><span class="line"><span class="keyword">const</span> token = ctx.request.body.token || ctx.query.token || ctx.headers[<span class="string">&#x27;x-access-token&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>具体逻辑如下：</p>
<ul>
<li>如果 POST 请求里携带了令牌信息，则优先获取</li>
<li>其次使用查询参数里的令牌</li>
<li>最后使用头部信息里的 x-access-token</li>
</ul>
<p>在 Koa 中，还有更好用的 koa-jwt 模块，示例如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;koa-jwt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/api&#x27;</span>, jwt(&#123;<span class="attr">secret</span>: <span class="string">&#x27;shared-secret&#x27;</span>&#125;), <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ctx.router available</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="OAuth"><a href="#OAuth" class="headerlink" title="OAuth"></a>OAuth</h5><ul>
<li>用户打开客户端以后，客户端要求用户给予授权</li>
<li>用户用以给予客户端授权</li>
<li>客户端使用上一步获得的授权，向认证服务器申请令牌</li>
<li>认证服务器对客户端进行认证以后，确认无误，同意发放令牌</li>
<li>客户端使用令牌，向资源服务器申请获取资源</li>
<li>资源服务器确认令牌无误，同意向客户端开放资源</li>
</ul>
<h2 id="常用中间件"><a href="#常用中间件" class="headerlink" title="常用中间件"></a>常用中间件</h2><h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><ul>
<li>koa-session: 基于 Cookie 的简单会话实现</li>
<li>koa-generic-session: Session Store 抽象层，莫表示让会话能够存储在 Redis 或 MongoDB 等自定义持久化存储中。它内置了 Memory Store,即内存存储。例如 koa-redis 是基于 Redis 存储的，koa-generic-session-mongo 是基于 MongoDB 存储的</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;koa-generic-session&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line">app.keys = [<span class="string">&#x27;keys&#x27;</span>, <span class="string">&#x27;keykeys&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加入全局中间件</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  store: <span class="keyword">new</span> RedisStore(),</span><br><span class="line">  ttl: <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// 半小时</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在路由中可以直接通过ctx.session对后面的中间件进行操作</span></span><br><span class="line">app.use(<span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (ctx.path) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;/get&#x27;</span>:</span><br><span class="line">      ctx.session.user = &#123; <span class="attr">name</span>: <span class="string">&#x27;i5ting&#x27;</span> &#125;</span><br><span class="line">      ctx.body = ctx.session.user</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;/remove&#x27;</span>:</span><br><span class="line">      ctx.session = <span class="literal">null</span></span><br><span class="line">      ctx.body = <span class="string">&quot;removed&quot;</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>get(sid) 根据 sid 来获取会话信息</li>
<li>set(sid, sess, ttl) 通过 sid 设置会话信息,ttl 指的是会话可存活时间 ms</li>
<li>destory(sid) 根据 sid 销毁会话</li>
</ul>
<h3 id="ETag"><a href="#ETag" class="headerlink" title="ETag"></a>ETag</h3><p>Etag 是前端缓存优化的重要部分.Etag 在服务器端生成后,客户端将通过 If-Match 或 If-None-Match 条件判断请求来验证资源是否被修改,其中比较常用的是 If-None-Match.如果资源没有用被修改则返回 304 状态码,如果修改则返回正常值.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> conditional = <span class="built_in">require</span>(<span class="string">&quot;koa-conditional-get&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> etag = <span class="built_in">require</span>(<span class="string">&quot;koa-etag&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// etag 模块通常和conditional-get模块一起使用</span></span><br><span class="line">app.use(conditional());</span><br><span class="line">app.use(etag());</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ETag 缓存是通过 conditional-get 拦截才能生效的</p>
</li>
<li><p>koa-conditional-get 一定要放在 koa-etag 前面</p>
<p>一开始进入页面<code>200</code>,<code>req</code>有字段<code>Pragma</code>,值为<code>no-cache</code></p>
<p>再次刷新<code>304</code>,<code>req</code>里面有字段<code>If-None-Match</code>,值为 ETag 的值</p>
</li>
</ul>
<h3 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h3><p>例如部分网上银行有一个动态口令验证码,原理是,银行放保留一个密钥 key,同时使用动态口令生成器中的 key 与银行方保持一致,通过 OPT 等协议算法生成 6 位数字.</p>
<p>OTP 全程 One-time Password,也称动态口令,是根据专门的算法每隔 60s 生成的一个与时间相关的,不可预测的随机数字组合(口令),每个口令只能使用一次,每天可以产生 43200 个口令</p>
<p>OTP 分为两种,HOTP 和 TOTP.HOTP 是基于加法计数器和静态对称密钥的算法.TOTP 是基于时间的一次性密码算法,是支持将时间作为动态因素的,基于 HMAC 一次性密码算法的扩展算法.</p>
<p>OTP 实现步骤如下:</p>
<ul>
<li>在一定时间范围(一般为 60s)内生成有效且复杂的字符串</li>
<li>对字符串进行散列计算</li>
<li>将结果转换为 6 位证书</li>
<li>让服务器与客户端保持时间,算法,key 同步一致</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  koa-opt.js</span></span><br><span class="line"><span class="keyword">const</span> notp = <span class="built_in">require</span>(<span class="string">&quot;notp&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> opt = &#123;</span><br><span class="line">  windows: <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = &#123;</span><br><span class="line">  encode: <span class="function"><span class="keyword">function</span> (<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> notp.totp.gen(key, opt);</span><br><span class="line">  &#125;,</span><br><span class="line">  decode: <span class="function"><span class="keyword">function</span> (<span class="params">key, token</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> login = notp.totp.verify(token, key, opt);</span><br><span class="line">    <span class="keyword">if</span> (!login) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;Token invalid&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    encode: <span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> token = app.encode(key);</span><br><span class="line">        ctx.otp_token = token;</span><br><span class="line">        <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">          cb(ctx, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> next();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    decode: <span class="function"><span class="keyword">function</span> (<span class="params">token, cb</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">        ctx.otp_valid = app.decode(key, token);</span><br><span class="line">        <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">          cb(ctx, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> next();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> opt = <span class="built_in">require</span>(<span class="string">&quot;./koa-opt&quot;</span>)(<span class="string">&quot;helloOpt&quot;</span>);</span><br><span class="line">app.use(</span><br><span class="line">  opt.encode(<span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      token: ctx.otp_token,</span><br><span class="line">      valid: ctx.otp_valid,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="限制访问频率"><a href="#限制访问频率" class="headerlink" title="限制访问频率"></a>限制访问频率</h3><p>最简单好用的方法是利用 Redis 的 expire 命令.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cache_expire</span>(<span class="params">k, v</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(client) &#123;</span><br><span class="line">    client.set(k, v, redis.print);</span><br><span class="line">    <span class="comment">// 60s后过去</span></span><br><span class="line">    client.expire(k, <span class="number">1</span>*<span class="number">60</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;redis client instance is not exit.&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次请求到来时,都需要先从缓存中查询一下,如果相应的 key 存在就不做任何处理,如果不存在就发送短信,并将 Key 保存到缓存中.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先检测缓存中是否有tel的key</span></span><br><span class="line">client.get(tel, <span class="function"><span class="keyword">function</span>(<span class="params">err, reply</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(reply) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;已存在: 不做任何处理&#x27;</span> + reply.toString())</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;不存在, 发送短信&#x27;</span>)</span><br><span class="line">    cache_expire(tel, a)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>要点如下:</p>
<ul>
<li>cache_expire 可以设置 Redis 的 Key</li>
<li>client.get 可以检测缓存里是否有 tel 的 Key,如果有就不做任何处理,如果没有就发送短信</li>
</ul>
<p>还有更简单的限制访问频率的方式比如使用 ratelimiter 模块,可以通过限制用户的连接频率来防止暴力破解类的攻击</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> email = req.body.email;</span><br><span class="line"><span class="keyword">var</span> db = <span class="built_in">require</span>(<span class="string">&#x27;ioredis).createClient();</span></span><br><span class="line"><span class="string">var limit = new Limiter(&#123;id: email, db: db&#125;);</span></span><br><span class="line"><span class="string">limit.get(function(err, limit) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;)</span></span><br></pre></td></tr></table></figure>

<p>可以将 ratelimiter 封装成一个中间件以供使用, 而且 ratelimiter 中本身也有 koa-ratelimiter 这个现成的中间件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ratelimt = <span class="built_in">require</span>(<span class="string">&#x27;koa-ratelimit&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> redis = <span class="built_in">require</span>(<span class="string">&#x27;redis&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> email = ratelimit(&#123;</span><br><span class="line">  db: <span class="keyword">new</span> Redis(),</span><br><span class="line">  duration: <span class="number">60000</span>,</span><br><span class="line">  errorMessage: <span class="string">&#x27;Sometimes You Just Have to Slow Down.&#x27;</span>,</span><br><span class="line">  id: <span class="function">(<span class="params">ctx</span>) =&gt;</span> ctx.email,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    remaining: <span class="string">&#x27;Rate-Limit-Remaining&#x27;</span>,</span><br><span class="line">    reset: <span class="string">&#x27;Rate-Limit-Reset&#x27;</span>,</span><br><span class="line">    total: <span class="string">&#x27;Rate-Limit-Total&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  max: <span class="number">10</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ip = ratelimit(&#123;</span><br><span class="line">   db: <span class="keyword">new</span> Redis(),</span><br><span class="line">  duration: <span class="number">60000</span>,</span><br><span class="line">  errorMessage: <span class="string">&#x27;Sometimes You Just Have to Slow Down.&#x27;</span>,</span><br><span class="line">  id: <span class="function">(<span class="params">ctx</span>) =&gt;</span> ctx.ip,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    remaining: <span class="string">&#x27;Rate-Limit-Remaining&#x27;</span>,</span><br><span class="line">    reset: <span class="string">&#x27;Rate-Limit-Reset&#x27;</span>,</span><br><span class="line">    total: <span class="string">&#x27;Rate-Limit-Total&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  max: <span class="number">100</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/login&#x27;</span>, ip, email, <span class="function"><span class="keyword">function</span>(<span class="params">ctx, next</span>) </span>&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>这里所做的就是限制了在一段时间内用户可以说尝试登陆的次数</p>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><table>
<thead>
<tr>
<th>术语，概念</th>
<th>SQL</th>
<th>MongoDB</th>
</tr>
</thead>
<tbody><tr>
<td>数据库</td>
<td>Database</td>
<td>Database</td>
</tr>
<tr>
<td>表</td>
<td>Table</td>
<td>Collection</td>
</tr>
<tr>
<td>行</td>
<td>Row</td>
<td>Document 或 BSON Document</td>
</tr>
<tr>
<td>列</td>
<td>Column</td>
<td>Field</td>
</tr>
<tr>
<td>索引</td>
<td>Index</td>
<td>Index</td>
</tr>
<tr>
<td>表关联</td>
<td>Table Joins</td>
<td>$lookup 或内嵌 Documents</td>
</tr>
<tr>
<td>主键</td>
<td>Primary Key</td>
<td>Primary Key, 默认为_id</td>
</tr>
<tr>
<td>聚合运算</td>
<td>Aggregation</td>
<td>Aggregation Pipeline</td>
</tr>
</tbody></table>
<h2 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h2><p>视图和和控制器的职责一目了然，但视图和控制器之间，以及控制器和数据库之间如何解耦，只是就需要用到模型，模型能让业务逻辑独立且清晰。</p>
<p>控制器的主要工作是访问 MongoDB 数据库，完成业务逻辑编写工作，然后将数据结果返回游览器。所以，核心的数据存取工作实在 MongoDB，及经典三层架构里的数据访问层中完成的。</p>
<p>模型又分为领域模型和视图模型，控制器和数据库之间的是领域模型，视图和控制器之间的是视图模型。<strong>模型和数据库表之间是一一对应的</strong>,在设计模型时，除了要考虑数据库表的结构，还需要考虑 UI 渲染因素。当然，设计表结构的时候，也要考虑用户交互 UI 和用户体验 UE.</p>
<p>模型还有一种分类方法：充血模型和贫血模型。贫血模型把“行为”(逻辑，过程)和“状态”(数据)分离到不同的对象中。只有状态的对象就是所谓的贫血对象(Value Object, VO)，而只有行为的对象就是我们常见的 N 层结构中的 Logic 层、Service 层、Manager 层。充血模型因为属于面向对象编程范畴，所以有更丰富的语义、更合理的组织和更强的可维护性。当然，贫血模型搭配 DAO(Data Access Object)和 Logic 层、Service 层、Manager 层也是不错的，是目前 JavaEE 中最常用的搭配。在 Node.js 中，以前不常用到面向对象思想，因此贫血模型就用的比较多，但随着 ES6 和 TypeScript 开始支持面向对象，未来 Node.js 应该会倾向与采用充血模型。</p>
<h2 id="模型的代码"><a href="#模型的代码" class="headerlink" title="模型的代码"></a>模型的代码</h2><p>该模型只包含用户名和密码</p>
<ol>
<li>JavaBean</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> username;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.username = username;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> password;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.password = password;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ES6</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">username</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title">username</span>(<span class="params">username</span>) &#123;</span><br><span class="line">    str = value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">password</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title">password</span>(<span class="params">username</span>) &#123;</span><br><span class="line">    str = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上给出的简单代码只是为了说明模型具有通用意义。除了与数据库相关的领域模型外，只要是紧耦合场景，只要抽查一个模型层，都会让代码具有可读性。</p>
<p>使用 Sequelize 模块定义的模型代码<code>User.js</code>如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = sequelize.define(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">  username: Sequelize.STRING,</span><br><span class="line">  password: Sequelize.STRING</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Mongoose 示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = Mongoose.model(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">  username: <span class="built_in">String</span>,</span><br><span class="line">  password: <span class="built_in">String</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="代码组织结构"><a href="#代码组织结构" class="headerlink" title="代码组织结构"></a>代码组织结构</h2><p><img src="https://wuzhaoyi-xyz.oss-cn-beijing.aliyuncs.com/books/langshu20200521161842.png"></p>
<ol>
<li>采用经典的 MVC 结构，包含 models, views 和 controllers 三个目录</li>
<li>包含 routes 目录，这是因为 Express 和 Koa 框架的路由都是独立的</li>
<li>包含 services 目录，这一点参考了 Java 项目，表示在控制器层和模型层之间增加了 Service 层。</li>
</ol>
<p><img src="https://wuzhaoyi-xyz.oss-cn-beijing.aliyuncs.com/books/langshu20200521162357.jpg"></p>
<p>在 Java 中，大家都习惯按照图示的流程完成响应请求，在 Node.js 的世界中，也可以采取类似的方式，虽然分层以后使用起来更加复杂，但对于大型项目来说，分层时必须的。</p>
<h3 id="安装与部署方式"><a href="#安装与部署方式" class="headerlink" title="安装与部署方式"></a>安装与部署方式</h3><h4 id="采用复制集-Replica-Set"><a href="#采用复制集-Replica-Set" class="headerlink" title="采用复制集(Replica Set)"></a>采用复制集(Replica Set)</h4><p>采用复制集是MongoDB的部署方式之一，复制集通常由三个对等的节点构成，由primary和secondary等多种角色。primary负责读/写请求，secondary负责读请求（由配置决定），secondary紧跟primary并应用写操作。如果primary失效，则集群进行“多数派”选举，选举出新的primary。复制集是MongoDB垂直扩展的最小部署单位,解决了单点故障的问题,分片集群中每个shard节点也可以使用复制集提高数据的可用性.但复制集也有缺点,只要在于集群数据的容量受限于每个节点的磁盘大小,如果数据量不断增加,对数据库进行扩容将是非常痛苦的事情.</p>
<h4 id="采用分片集群-Sharding-Cluster"><a href="#采用分片集群-Sharding-Cluster" class="headerlink" title="采用分片集群(Sharding Cluster)"></a>采用分片集群(Sharding Cluster)</h4><p>为了解决上述复制集的问题,需要采用分片模式,将整个集合Collection中的数据根据分片键sharding key分别存储到多个MongoDB节点上,即让每个节点持有集合的一部分数据,集群持有全部数据.这样一来,原则上分片可以支撑TB级的数据,这种方式应对高并发,超大数据量的场景时,是非常好的.</p>
<p>在对系统进行配置时需要注意以下几点:</p>
<ul>
<li><p>建议将MongoDB部署到Linux系统上,选择较高的版本,以及合适的底层文件系统Ext4,开启合适的Swap空间.</p>
</li>
<li><p>无论是采用MMAPv1还是WiredTiger引擎,较大的内存总能带来直接的好处.</p>
</li>
<li><p>关闭数据存储文件的atime选项(表示我呢见最近被访问的时间,每次访问文件时这个时间都会被修改),可以提升文件访问效率.</p>
</li>
<li><p>调整ulimit参数.在基于网络I/O或者磁盘I/O进行操作的应用中,通常要调整这个参数,主要是为了上调系统允许大开的文件个数.</p>
</li>
</ul>
<p>推荐以复制集位单位进行部署，简单高效，搭建分片集群是非常麻烦的，不推荐非专业的运维人士使用。</p>
<h3 id="在Ubuntu上安装"><a href="#在Ubuntu上安装" class="headerlink" title="在Ubuntu上安装"></a>在Ubuntu上安装</h3><h3 id="更好的启动方式"><a href="#更好的启动方式" class="headerlink" title="更好的启动方式"></a>更好的启动方式</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ! /bin/bash</span></span><br><span class="line">❯ mkdir -p tmp/db</span><br><span class="line">❯ mkdir -p tmp/pids</span><br><span class="line">❯ mkdir -p tmp/logs</span><br><span class="line"><span class="meta">#</span><span class="bash"> remove lock file</span> </span><br><span class="line">❯ [ -f tmp/db/mongod.lock ] &amp;&amp; rm -rf tmp/db/mongod.lock</span><br><span class="line">❯ touch tmp/pids/mongodb.pid</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">❯ nohup mongod --bind_ip 127.0.0.1 --port 27017 --dbpath tmp/db --logpath tmp/logs/mongodb.log --pidfilepath tmp/pids/mongodb.pid &gt;mongod.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<pre><code>上面的shell脚本完成了如下四项内容。
- 创建目录db,pids和logs
- 如果有锁文件，则需要移除
- 创建进程id文件
- 通过mongod命令启动服务器，指定目录，IP地址，日志，进程号等。
</code></pre>
<p>很明显，上面的步骤不太好记，写成shell脚本也比较麻烦，更好的办法是将shell脚本嵌入npm，以二进制模块的方式进行全局安装。mh就是这样的启动模块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i -g mh</span><br><span class="line">mh</span><br></pre></td></tr></table></figure>

<p>mh内置了两条命令</p>
<ul>
<li>当mh在当前目录下启动时，数据独立</li>
<li>当mh在用户主目录下启动时，数据共享</li>
</ul>
<p>对于日常开发来说，推荐使用跨平台MongoDB管理客户端Robo 3T，拥有可视化界面</p>
<h2 id="Mongoose基础"><a href="#Mongoose基础" class="headerlink" title="Mongoose基础"></a>Mongoose基础</h2><p>与MySql那样的关系型数据库相比,他显得更轻巧,灵活,非常适合在数据规模很大,事务性不强的场景下使用.同时MongoDB也是一个对象数据库,其中没有表,行等概念,也没有固定的模式和结构,所有的数据以文档的形式存储.所谓文档,就是一个关联数组式的对象,由属性组成,一个属性对应的值可能是一个数,字符串,日期,数组,甚至是一个嵌套的文档.MongoDB存储的数据格式是类似JSON的BSON格式.</p>
<h3 id="Mongo-简介"><a href="#Mongo-简介" class="headerlink" title="Mongo 简介"></a>Mongo 简介</h3><p>Mongoose是MongoDB的一个对象模型工具.可以在Node.js异步环境下执行.同时它也是一个针对MongoDB操作的对象模型库,封装了MongoDB对文档操作的常用方法.</p>
<p>可以把Mongoose理解为简易版的ORM(Object-Relation-Mapping,对象关系映射),Mongoose提供了类似Schema表结构的定义,以及Hook,Plugin,Virtual,Populate等机制.</p>
<p>Mongoose是WordPress母公司Automattic发布的开源项目.</p>
<h3 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save mongoose</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>)</span><br><span class="line"><span class="comment">// 使用Mongoose连接数据库</span></span><br><span class="line"><span class="keyword">const</span> db = Mongoose.connect(<span class="string">&quot;mongodb://user:pass@ip:port/database&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>说明:</p>
<ul>
<li><p>user是MongoDB里的用户名</p>
</li>
<li><p>pass是MongoDB里该用户对应的密码</p>
</li>
<li><p>ip是MongoDB服务器可以访问的ip地址,如127.0.0.1</p>
</li>
<li><p>port是MongoDB服务器可以访问的端口,默认是27017</p>
<p>连接MySQL和MongoDB本质上都是TCP连接,所以配置也大同小异</p>
</li>
</ul>
<h4 id="测试连接"><a href="#测试连接" class="headerlink" title="测试连接"></a>测试连接</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>)</span><br><span class="line"><span class="comment">// 使用Mongoose连接数据库</span></span><br><span class="line"> Mongoose.connect(<span class="string">&quot;mongodb://127.0.0.1:27017/db_hello&quot;</span>, &#123;</span><br><span class="line">    useNewUrlParser: <span class="literal">true</span>,</span><br><span class="line">    useUnifiedTopology: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> db = Mongoose.connection;</span><br><span class="line">db.on(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;数据库连接失败:&#x27;</span>+error)</span><br><span class="line">&#125;);</span><br><span class="line">db.once(<span class="string">&#x27;open&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// we&#x27;re connected!</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;数据库连接成功&#x27;</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="最小示例"><a href="#最小示例" class="headerlink" title="最小示例"></a>最小示例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 最小示例</span></span><br><span class="line"><span class="keyword">const</span> Mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>)</span><br><span class="line">Mongoose.connect(<span class="string">&quot;mongodb://127.0.0.1:27017/db_hello&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Cat = Mongoose.model(<span class="string">&#x27;Cat&#x27;</span>, &#123; <span class="attr">name</span>: <span class="built_in">String</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过关键字new实例化Cat模型，参数是&#123; name: &#x27;Tom&#x27; &#125;，创建kitty对象</span></span><br><span class="line"><span class="keyword">const</span> kitty = <span class="keyword">new</span> Cat(&#123; <span class="attr">name</span>: <span class="string">&#x27;Tom&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行kitty.save,将模型保存到数据库</span></span><br><span class="line">kitty.save(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="built_in">console</span>.log(<span class="string">&#x27;save error&#x27;</span> + err)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;save success&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>上述有3个核心步骤</p>
<ul>
<li>定义模型</li>
<li>通过关键字new实例化Cat模型，创建kitty对象</li>
<li>执行kitty.save方法，将模型数据保存到数据库</li>
</ul>
<p>总结下：首先约定Schema，即定义模型时指定字段和字段类型，避免出现乱用<code>scheme-free</code>的问题；然后，对实例化模型创建的对象进行操作，完成常见的增删改查功能。定义模型即定义对象，对对象进行操作即对数据库进行操作。</p>
<h4 id="Hello-Mongoose"><a href="#Hello-Mongoose" class="headerlink" title="Hello Mongoose"></a>Hello Mongoose</h4><p>连接数据库的实际代码<code>db/mini/connect.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>)</span><br><span class="line"></span><br><span class="line">Mongoose.connect(<span class="string">&#x27;mongodb://127.0.0.1:27017/db_hello&#x27;</span>, &#123;</span><br><span class="line">    useNewUrlParser: <span class="literal">true</span>,</span><br><span class="line">    useUnifiedTopology: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Mongoose.connection.on(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;数据库连接失败&#x27;</span> + error)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Mongoose.connection.on(<span class="string">&#x27;open&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;数据库连接成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line"><span class="comment">// 使用 createConnection , 返回connection对象</span></span><br><span class="line"><span class="keyword">const</span> db = Mongoose.createConnection(<span class="string">&#x27;mongodb://127.0.0.1:27017/db_hello&#x27;</span>, &#123;</span><br><span class="line">    useNewUrlParser: <span class="literal">true</span>,</span><br><span class="line">    useUnifiedTopology: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//这里也有区别，直接操作connection</span></span><br><span class="line">db.on(<span class="string">&#x27;connected&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;数据库连接失败&#x27;</span> + error)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;数据库连接成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>一般在项目里面，所有模型都共用一个数据库连接信息，把连接数据库的代码抽取到connect.js中，然后在引用入口引用，这样整个应用里就只存在一个数据库连接了</p>
<p>定义模型<code>db/mini/user.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>)</span><br><span class="line"></span><br><span class="line">UserSchema = <span class="keyword">new</span> Mongoose.Schema(&#123;</span><br><span class="line">    username: &#123; <span class="comment">// 用户名</span></span><br><span class="line">        type: <span class="built_in">String</span>,</span><br><span class="line">        required: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    password: &#123; <span class="comment">// 密码</span></span><br><span class="line">        type: <span class="built_in">String</span>,</span><br><span class="line">        required: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义模型</span></span><br><span class="line"><span class="keyword">const</span> UserModel = Mongoose.model(<span class="string">&#x27;User&#x27;</span>, UserSchema)</span><br><span class="line"><span class="comment">// createSign 使用 conncetion对象</span></span><br><span class="line"><span class="comment">// const UserModel = db.model(&#x27;User12&#x27;, UserSchema)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UserModel</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是MVC中做常见的代码，没有连接信息，也没有其他额外不相干的的代码，一般看user.js文件就能理解它在数据库里对应的表结构，以及字段类型，约束等信息。</p>
<p>实际测试代码<code>db/mini/test.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./connect&#x27;</span>)</span><br><span class="line"><span class="comment">// 引入模型定义文件</span></span><br><span class="line"><span class="keyword">const</span> User = <span class="built_in">require</span>(<span class="string">&#x27;./user&#x27;</span>)</span><br><span class="line"><span class="comment">// 实例化模型</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">new</span> User(&#123;</span><br><span class="line">    username: <span class="string">&#x27;wzy&#x27;</span>,</span><br><span class="line">    password: <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">user.save(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;save error:&#x27;</span> + err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;save success \n&#x27;</span> + doc)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>核心步骤：</p>
<ul>
<li>引入数据库连接，保证MongoDB已经连接成功</li>
<li>引入模型定义文件，完成文档（表）结构的定义</li>
<li>实例化User模型，创建user实体</li>
<li>通过user实体对数据库进行操作，完成用户注册</li>
</ul>
<h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><h4 id="对象关系映射"><a href="#对象关系映射" class="headerlink" title="对象关系映射"></a>对象关系映射</h4><p>面向对象是软件工程基本原则（耦合、聚合、封装）的基础上发展起来的，而关系型数据库则是从数学理论中发展而来的，两套理论存在显著区别。为了解决二者不匹配的问题，对象关系映射技术应运而生。</p>
<p>对象关系映射(Object Relational Mappling,简称ORM)是一种程序设计技术，用于实现面向对象编程语言里不同类型系统数据之间的转换。从效果上说，它实际上创建了一个可以在编程语言里使用的“虚拟对象数据库”。</p>
<p>几乎所有程序里都存在对象和关系型数据库，在业务逻辑层和用户界面层中，推荐使用面向对象的写法。当对象信息发生变化的时候，把对象信息保存到关系型数据库中。</p>
<p>ORM提供了概念性的、易于理解的模型化数据的方法。对于MongoDB这种基于文档的非关系型数据库来说，与ORM对应的概念是ODM(Object-Document Mapper)，即对象文档映射。</p>
<p>ORM是关系型数据库的对象关系映射工具，ODM是MongoDB特有的对象文档映射工具，而Mongoose是ORM工具。</p>
<h4 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h4><p>Schema是一种以文件形式存储的数据库模型骨架，并不直接连接数据库，也就是说他不具备对数据库操作的能力，仅仅负责定义数据库模型在程序中的映射配置。可以说Schema是数据属性模型（传统意义上的表结构），或者“集合”的模型骨架。Schema是对文档（表）结构的定义。</p>
<p>Schema的基本属性类型有字符串、日期、数值、布尔值、null、数组、内嵌文档等，当然它还有更丰富的字段进行校验约束功能。</p>
<h4 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h4><p>模型是由Schema构造而来的，除了包含Schema定义的数据库骨架以外，还包含了对数据库操作的行为，可以把它理解成操作Schema属性与行为的类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span>  UserModel = Mongoose.model(<span class="string">&#x27;User&#x27;</span>, UserSchema);</span><br></pre></td></tr></table></figure>

<p>User是模型名称，对应的MongoDB中的概念就是数据库中的集合名称，默认会转成复数，即users。当我们对数据库添加数据时秒如果users已经存在，则将数据保存到users集合中即可；如果users不存在，则需要创建users集合，然后保存数据。</p>
<p>在后面的内容中，我们会使用模型来执行增删改查操作，所以一定要熟悉它的创建格式。如果想对某个Collect进行操作，就交给模型。创建一个模型，需要指定集合名称及集合的Schema结构对象。</p>
<h4 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h4><p>实体是由模型创建的，它使用save方法来保存数据。模型和实体都能执行影响数据库的操作，但前者更具操作性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = <span class="keyword">new</span> User(&#123;</span><br><span class="line">	username: <span class="string">&#x27;prajna&#x27;</span>,</span><br><span class="line">	password: <span class="string">&#x27;01234&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>创建成功之后，Schema的属性就变成了模型和实体的公共属性。</p>
<p>总结：Schema是骨架，模型是根据Schema创建的模板类，也就是Schema和模型是对数据库表的定义，而实体是模型实例化后的对象，是真正具有数据库操作能力的对象。</p>
<p>所以，我们会把数据库表的定义部分（Schema + 模型)和实体分开，此时定义是不变的。而通过实体对数据库进行操作时，数据是会产生变化的。所以在进行MVC分层的时候，模型中实际上放的是定义部分，而Contorller层里使用的是实体部分。</p>
<h3 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h3><p>CRUD为Create(增加),Retrieve(读取),Update(更新)和Delete(删除)几个单词的首字母组合.Mongoose提供了如下的Crud方法.</p>
<ul>
<li>增加: save</li>
<li>读取: find, findOne</li>
<li>更新: update, findByIdAndUpdate, findOneAndUpdate</li>
<li>删除: remove</li>
</ul>
<h4 id="增加"><a href="#增加" class="headerlink" title="增加"></a>增加</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = <span class="keyword">new</span> User(&#123;</span><br><span class="line">	username: <span class="string">&#x27;prajna&#x27;</span>,</span><br><span class="line">	password: <span class="string">&#x27;01234&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line">user.save(<span class="function">(<span class="params">err,u</span>) =&gt;</span> &#123;</span><br><span class="line">	t.false(err);</span><br><span class="line">	t.is(u.username, <span class="string">&#x27;wzy&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>save还有一个别名,create</p>
<h4 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h4><p>执行读取操作时有两个API: find 和 findOne.其中,find表示根据条件查询并返回数组; findOne表示根据条件查询并返回一个数据对象.</p>
<ol>
<li><p>find</p>
<p>find表示根据条件查询,返回的是数组.</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">User.find(&#123;&#125;, <span class="function">(<span class="params">err, docs</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;find error:&#x27;</span> + err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;find success&#x27;</span> + docs)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>findOne</p>
<p>findOne表示根据条件查询,返回的是一个数据对象</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">User.findOne(&#123;&#125;, <span class="function">(<span class="params">err, docs</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;find error:&#x27;</span> + err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;find success&#x27;</span> + docs)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>其实还有findOneAndUpdate,findAndModify,findByIdAndUpdate,findOneAndRemove,findByIdAndRemove等辅助方法.</p>
<p>更新,除了update方法,更新操作还可以通过很多其他方法来完成.比如findByIdAndUpdate,findOneAndUpdate</p>
<h4 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h4><ol>
<li><p>update</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">Parameters</span></span><br><span class="line"><span class="comment">conditions «Object»</span></span><br><span class="line"><span class="comment">doc «Object»</span></span><br><span class="line"><span class="comment">[options] «Object» optional see Query.prototype.setOptions()</span></span><br><span class="line"><span class="comment">[callback] «Function»</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//多条</span></span><br><span class="line">User.update(&#123; <span class="attr">username</span>: <span class="string">&#x27;wzy&#x27;</span> &#125;, &#123; <span class="attr">password</span>: <span class="string">&#x27;basketball&#x27;</span> &#125;, &#123; <span class="attr">multi</span>: <span class="literal">true</span> &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, raw</span>) </span>&#123; <span class="comment">// multi多匹配</span></span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;The raw response from Mongo was &#x27;</span>, raw);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li><p>findByIdAndUpdate</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">Parameters</span></span><br><span class="line"><span class="comment">id «Object|Number|String» value of _id to query by</span></span><br><span class="line"><span class="comment">[update] «Object»</span></span><br><span class="line"><span class="comment">[options] «Object» optional see Query.prototype.setOptions()</span></span><br><span class="line"><span class="comment">[options.lean] «Object» if truthy, mongoose will return the document as a plain JavaScript object rather than a mongoose document. See Query.lean().</span></span><br><span class="line"><span class="comment">[callback] «Function»</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">User.findByIdAndUpdate(<span class="string">&#x27;5ec62cbc797f681cdcd257e2&#x27;</span>, &#123;</span><br><span class="line">    username: <span class="string">&#x27;wjj&#x27;</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;The raw response from Mongo was &#x27;</span>, raw);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li><p>findOneAndUpdate</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">Parameters</span></span><br><span class="line"><span class="comment">[conditions] «Object»</span></span><br><span class="line"><span class="comment">[update] «Object»</span></span><br><span class="line"><span class="comment">[options] «Object» optional see Query.prototype.setOptions()</span></span><br><span class="line"><span class="comment">[options.lean] «Object» if truthy, mongoose will return the document as a plain JavaScript object rather than a mongoose document. See Query.lean().</span></span><br><span class="line"><span class="comment">[callback] «Function»</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">User.findOneAndUpdate(&#123;</span><br><span class="line">    username: <span class="string">&#x27;wjj2&#x27;</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    password: <span class="string">&#x27;wjj2&#x27;</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="built_in">console</span>.log(<span class="string">&#x27;find error:&#x27;</span> + err)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;The raw response from Mongo was &#x27;</span>, raw);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h4>   <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User.remove(&#123;<span class="attr">username</span>: <span class="string">&#x27;wzy_copy&#x27;</span>&#125;, <span class="function">(<span class="params">err, doc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="built_in">console</span>.log(<span class="string">&#x27;find error:&#x27;</span> + err)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;The doc response from Mongo was &#x27;</span>, doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> test = <span class="built_in">require</span>(<span class="string">&#x27;ava&#x27;</span>)</span><br><span class="line"><span class="keyword">import</span> &#123; MongoMemoryServer &#125; <span class="keyword">from</span> <span class="string">&#x27;mongodb-memory-server&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mongoose.Promise = <span class="built_in">require</span>(<span class="string">&#x27;bluebird&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义Schema</span></span><br><span class="line"><span class="keyword">const</span> UserSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    username: &#123;</span><br><span class="line">        type: <span class="built_in">String</span>,</span><br><span class="line">        required: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    password: &#123;</span><br><span class="line">        type: <span class="built_in">String</span>,</span><br><span class="line">        required: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义User模型</span></span><br><span class="line"><span class="keyword">const</span> User = mongoose.model(<span class="string">&#x27;UserTest&#x27;</span>, UserSchema)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义user实体</span></span><br><span class="line"><span class="keyword">let</span> user = <span class="keyword">new</span> User(&#123;</span><br><span class="line">    username: <span class="string">&#x27;wj&#x27;</span>,</span><br><span class="line">    password: <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动MongoDB 实例</span></span><br><span class="line"><span class="keyword">const</span> mongod = <span class="keyword">new</span> MongoMemoryServer()</span><br><span class="line"></span><br><span class="line"><span class="comment">//在运行测试用例之前,需要创建数据库连接</span></span><br><span class="line">test.before(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> uri = <span class="keyword">await</span> mongod.getConnectionString()</span><br><span class="line">    <span class="keyword">await</span> mongoose.connect(uri, &#123;</span><br><span class="line">        <span class="comment">// useMongoClient: true,</span></span><br><span class="line">        autoIndex: <span class="literal">false</span>,</span><br><span class="line">        reconnectTries: <span class="built_in">Number</span>.MAX_VALUE,</span><br><span class="line">        reconnectInterval: <span class="number">1000</span>,</span><br><span class="line">        poolSize: <span class="number">10</span>,</span><br><span class="line">        bufferMaxEntries: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test.beforeEach(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    user = <span class="keyword">await</span> user.save()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test.after(<span class="function">() =&gt;</span> User.remove())</span><br><span class="line"></span><br><span class="line">test.serial(<span class="string">&#x27;# find return array&#x27;</span>, <span class="keyword">async</span> (t) =&gt; &#123;   <span class="comment">// 串行测试</span></span><br><span class="line">    <span class="keyword">const</span> users = <span class="keyword">await</span> User.find(&#123;&#125;)</span><br><span class="line">    t.true(users <span class="keyword">instanceof</span> <span class="built_in">Array</span>)</span><br><span class="line">    <span class="keyword">const</span> _user1 = <span class="keyword">await</span> User.findOne(&#123; <span class="attr">username</span>: <span class="string">&#x27;wj&#x27;</span> &#125;)</span><br><span class="line">    t.true(_user1.username === <span class="string">&#x27;wj&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test.serial(<span class="string">&#x27;# findById return one&#x27;</span>, <span class="keyword">async</span> (t) =&gt; &#123;   <span class="comment">// 串行测试</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> _user1 = <span class="keyword">await</span> User.findOne(&#123; <span class="attr">username</span>: <span class="string">&#x27;wj&#x27;</span> &#125;)</span><br><span class="line">        <span class="keyword">const</span> _user = <span class="keyword">await</span> User.findById(_user1.id)</span><br><span class="line">        t.is(_user.username, <span class="string">&#x27;wj&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        t.ifError(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test.serial(<span class="string">&#x27;# findOneAndUpdate&#x27;</span>, <span class="keyword">async</span> (t) =&gt; &#123;   <span class="comment">// 串行测试</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> user.update(&#123; <span class="attr">username</span>: <span class="string">&#x27;wj for update&#x27;</span> &#125;)</span><br><span class="line">        <span class="keyword">const</span> _user = <span class="keyword">await</span> User.findById(user.id)</span><br><span class="line">        t.is(_user.username, <span class="string">&#x27;wj for update&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        t.ifError(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test.serial(<span class="string">&#x27;#remove return array&#x27;</span>, <span class="keyword">async</span> (t) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> User.remove(&#123;&#125;)</span><br><span class="line">    <span class="keyword">const</span> _user1 = <span class="keyword">await</span> User.findOne(&#123; <span class="attr">username</span>: <span class="string">&#x27;wj&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    t.true(_user1 === <span class="literal">null</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm test</span><br><span class="line">  4 tests passed</span><br></pre></td></tr></table></figure>

<p>在测试代码里,我们不需要真的调用数据库的具体方法,一般使用Sinon这样的库来模拟操作即可.比如,给UserModel增加一个save方法.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">&#x27;sinon&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sinon.stub(UserModel, <span class="string">&#x27;save&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    cb(<span class="string">&#x27;fake error&#x27;</span>m <span class="literal">null</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="调试模式"><a href="#调试模式" class="headerlink" title="调试模式"></a>调试模式</h4><p>调试模式是Mongoose提供的一个非常实用的功能,用于查看Mongoose模块对MongoDB操作的日志.一般我们在进行开发时会打开此功能,以便更好地优化对MongoDB的操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 核心代码，开启调试模式</span></span><br><span class="line">mongoose.set(<span class="string">&#x27;debug&#x27;</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Schema的类型"><a href="#Schema的类型" class="headerlink" title="Schema的类型"></a>Schema的类型</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">node mongooseTest.js </span><br><span class="line"></span><br><span class="line">String</span><br><span class="line">Number</span><br><span class="line">Boolean</span><br><span class="line">DocumentArray</span><br><span class="line">Embedded</span><br><span class="line">Array</span><br><span class="line">Buffer</span><br><span class="line">Date</span><br><span class="line">ObjectId</span><br><span class="line">Mixed</span><br><span class="line">Decimal</span><br><span class="line">Decimal128</span><br><span class="line">Map</span><br><span class="line">Oid</span><br><span class="line">Object</span><br><span class="line">Bool</span><br><span class="line">ObjectID</span><br></pre></td></tr></table></figure>

<p>下面时更完整的示例，以及如何在项目中更好的使用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> Schema = Mongoose.Schema;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> schema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">    name: <span class="built_in">String</span>,</span><br><span class="line">    binary: Buffer,</span><br><span class="line">    living: <span class="built_in">Boolean</span>,</span><br><span class="line">    updated: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">    age: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">min</span>: <span class="number">18</span>, <span class="attr">max</span>: <span class="number">65</span> &#125;,</span><br><span class="line">    mixed: Schema.Types.Mixed,</span><br><span class="line">    _someId: Schema.Types.ObjectId,</span><br><span class="line">    decimal: Schema.Types.Decimal128,</span><br><span class="line">    array: [],</span><br><span class="line">    ofString: [<span class="built_in">String</span>],</span><br><span class="line">    ofNumber: [<span class="built_in">Number</span>],</span><br><span class="line">    ofDates: [<span class="built_in">Date</span>],</span><br><span class="line">    ofBuffer: [Buffer],</span><br><span class="line">    ofBoolean: [<span class="built_in">Boolean</span>],</span><br><span class="line">    ofMixed: [Schema.Types.Mixed],</span><br><span class="line">    ofObjectId: [Schema.Types.ObjectId],</span><br><span class="line">    ofArrays: [[]],</span><br><span class="line">    ofArrayOfNumbers: [[<span class="built_in">Number</span>]],</span><br><span class="line">    nested: &#123;</span><br><span class="line">        stuff: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">lowercase</span>: <span class="literal">true</span>, <span class="attr">trim</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Thing = Mongoose.model(<span class="string">&#x27;Thing&#x27;</span>, schema);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> Thing;</span><br><span class="line">m.name = <span class="string">&#x27;Statue of Liberty&#x27;</span>;</span><br><span class="line"><span class="comment">// m.age = 125;</span></span><br><span class="line">m.updated = <span class="keyword">new</span> <span class="built_in">Date</span>;</span><br><span class="line"><span class="comment">// m.binary = new Buffer(0);</span></span><br><span class="line">m.living = <span class="literal">false</span>;</span><br><span class="line">m.mixed = &#123; <span class="attr">any</span>: &#123; <span class="attr">thing</span>: <span class="string">&#x27;i want&#x27;</span> &#125; &#125;;</span><br><span class="line">m.markModified(<span class="string">&#x27;mixed&#x27;</span>);</span><br><span class="line">m._someId = <span class="keyword">new</span> Mongoose.Types.ObjectId;</span><br><span class="line">m.array.push(<span class="number">1</span>);</span><br><span class="line">m.ofString.push(<span class="string">&quot;strings!&quot;</span>);</span><br><span class="line">m.ofNumber.unshift(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">m.ofDates.addToSet(<span class="keyword">new</span> <span class="built_in">Date</span>);</span><br><span class="line">m.ofBuffer.pop();</span><br><span class="line">m.ofMixed = [<span class="number">1</span>, [], <span class="string">&#x27;three&#x27;</span>, &#123; <span class="attr">four</span>: <span class="number">5</span> &#125;];</span><br><span class="line">m.nested.stuff = <span class="string">&#x27;good&#x27;</span>;</span><br><span class="line">m.save(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="built_in">console</span>.log(<span class="string">&#x27;save error&#x27;</span> + err)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;save success&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Mongoose-进阶"><a href="#Mongoose-进阶" class="headerlink" title="Mongoose 进阶"></a>Mongoose 进阶</h2><h3 id="模型扩展"><a href="#模型扩展" class="headerlink" title="模型扩展"></a>模型扩展</h3><p>模型有充血贫血之分,充血模型简单的理解就是模型自身带有行为.在MVC模式里,模型层和业务层之间的职业要做好区分,适当地将业务行为下沉到模型层,代码会更加清晰,可维护性也更高.</p>
<p>一般情况下,我们对业务进行如下的分层处理.</p>
<p>Service层 (多模型操作) =&gt; DAO层(单一模型操作) =&gt; 模型层(模型定义)</p>
<p>我们需要在DAO层封装很多单一模型的数据库操作方法.但是,如果业务非常复杂,比如有一个超级查询方法,还有各种具体业务的定义方法,难道要将这些全部写在DAO层嘛?</p>
<p>事实上,DAO层只提供暴露给Service层的方法,而具有一定业务约定的方法是要封装到模型层的.如果把DAO层的很多底层方法下沉到模型层,就可以让这两个分层的职责更加清晰.所以,我们需要利用Mongoose的模型扩展来重新定义分层,扩展后的分层结构如下.</p>
<p>Service层(多模型操作) =&gt; DAO层(单一模型操作) =&gt; 模型层(模型定义+扩展方法)</p>
<p>Mongoose提供的模型扩展方法有两种,如下:</p>
<ul>
<li><p>statics: 类上扩展</p>
</li>
<li><p>methods: 对象上扩展</p>
</li>
</ul>
<h4 id="类上扩展"><a href="#类上扩展" class="headerlink" title="类上扩展"></a>类上扩展</h4><p>假设有这样一个需求,根据用户名查找用户.那么这个查找用户的行为到底是放到类的静态方法上,还是放到示例方法上呢</p>
<p>对于这种不属于某个用户的具体行为,在类上扩展会更好</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UserSchema.statics.find_by_username = <span class="function"><span class="keyword">function</span>(<span class="params">username, cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.findOne(&#123;</span><br><span class="line">        username: username</span><br><span class="line">    &#125;, cb)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>by_username是User模型的静态方法,调用方法如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> User = mongoose.model(<span class="string">&#x27;User&#x27;</span>,UserScheme)</span><br><span class="line">User.find_by_username(openod, cb)</span><br></pre></td></tr></table></figure>

<h4 id="对象上扩展"><a href="#对象上扩展" class="headerlink" title="对象上扩展"></a>对象上扩展</h4><p>如果是用户的具体行为,在对象上扩展会更具有可读性.在对象上扩展行为时,需根据当前模型已有的属性进行扩展,再结合查询进行晚上,这样实现的功能会非常强大.比如判断某个用户是否存在,就是典型的用户的具体行为.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">UserSchema.methods.is_exist = <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> query;</span><br><span class="line">    query = &#123;</span><br><span class="line">        username: <span class="built_in">this</span>.username,</span><br><span class="line">        password: <span class="built_in">this</span>.password</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.model(<span class="string">&#x27;UserModel&#x27;</span>).findOne(query, cb)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要创建也User对象.才能调用is_exist方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = <span class="keyword">new</span> User</span><br><span class="line">user.is_exist(cb)</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:hqwuzhaoyi@foxmail.com">Wu Zhaoyi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://hqwuzhaoyi.github.io/2020/04/07/node/68.%E7%8B%BC%E4%B9%A6/">https://hqwuzhaoyi.github.io/2020/04/07/node/68.%E7%8B%BC%E4%B9%A6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hqwuzhaoyi.github.io" target="_blank">Prajna's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/koa/">koa</a><a class="post-meta__tags" href="/tags/node/">node</a></div><div class="post_share"><div class="social-share" data-image="https://wuzhaoyi-xyz.oss-cn-beijing.aliyuncs.com/vue/20200407153942.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/04/07/%E4%B8%AA%E4%BA%BA%E9%85%8D%E7%BD%AE/p02.vscode/"><img class="prev-cover" src="https://wuzhaoyi-xyz.oss-cn-beijing.aliyuncs.com/vue/20200407160117.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">vscode 配置</div></div></a></div><div class="next-post pull-right"><a href="/2020/03/18/vue/67.vue%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA/"><img class="next-cover" src="https://wuzhaoyi-xyz.oss-cn-beijing.aliyuncs.com/vue/vue深入浅出.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">vue深入浅出</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#http-%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">http 知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text">请求响应模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82"><span class="toc-number">1.1.1.</span> <span class="toc-text">请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94"><span class="toc-number">1.1.2.</span> <span class="toc-text">响应</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9"><span class="toc-number">1.1.3.</span> <span class="toc-text">核心要点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stream"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">Stream</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.3.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">1.1.3.1.2.</span> <span class="toc-text">文件操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Http-%E4%BB%A3%E7%90%86"><span class="toc-number">1.1.3.1.3.</span> <span class="toc-text">Http 代理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EventEmitter"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">EventEmitter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">请求事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">响应事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http-Server-%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.1.3.5.</span> <span class="toc-text">http.Server 事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81"><span class="toc-number">1.1.3.6.</span> <span class="toc-text">HTTP 模块源码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTPS"><span class="toc-number">1.2.</span> <span class="toc-text">HTTPS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-number">1.2.1.</span> <span class="toc-text">生成证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%AF%81%E4%B9%A6"><span class="toc-number">1.2.2.</span> <span class="toc-text">使用证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HSTS"><span class="toc-number">1.2.3.</span> <span class="toc-text">HSTS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-HTTPS-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.4.</span> <span class="toc-text">Nginx HTTPS 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proxy"><span class="toc-number">1.3.</span> <span class="toc-text">Proxy</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Koa"><span class="toc-number">2.</span> <span class="toc-text">Koa</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80"><span class="toc-number">2.1.</span> <span class="toc-text">基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#parseurl"><span class="toc-number">2.1.1.</span> <span class="toc-text">parseurl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E5%A4%B4%E9%83%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">HTTP 头部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http-%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-number">2.1.3.</span> <span class="toc-text">http 状态码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie"><span class="toc-number">2.1.4.</span> <span class="toc-text">Cookie</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8-Node-js-%E4%B8%AD%EF%BC%8CCookie-%E6%98%AF%E9%80%9A%E8%BF%87-response-writeHead-%E8%A2%AB%E5%86%99%E5%85%A5%E7%9A%84%EF%BC%8C%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B"><span class="toc-number">2.1.4.1.</span> <span class="toc-text">在 Node.js 中，Cookie 是通过 response.writeHead 被写入的，代码如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Koa-%E5%86%99%E5%85%A5-Cookie"><span class="toc-number">2.1.4.2.</span> <span class="toc-text">使用 Koa 写入 Cookie</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0%E7%9A%84%E4%B8%89%E7%A7%8D%E4%B8%8D%E5%90%8C%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">获取参数的三种不同方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%85%B7%E5%90%8D%E5%8F%82%E6%95%B0-params"><span class="toc-number">2.2.1.</span> <span class="toc-text">获取具名参数 params</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E8%AF%B7%E6%B1%82%E4%BD%93-body"><span class="toc-number">2.2.2.</span> <span class="toc-text">解析请求体 body</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9F%A5%E8%AF%A2%E5%AD%97%E7%AC%A6%E4%B8%B2-query"><span class="toc-number">2.2.3.</span> <span class="toc-text">获取查询字符串 query</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#body-%E8%A7%A3%E6%9E%90"><span class="toc-number">2.3.</span> <span class="toc-text">body 解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96"><span class="toc-number">2.3.1.</span> <span class="toc-text">模块依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E7%B1%BB%E5%9E%8B%E5%88%97%E8%A1%A8"><span class="toc-number">2.3.2.</span> <span class="toc-text">表单类型列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84-POST"><span class="toc-number">2.3.3.</span> <span class="toc-text">常见的 POST</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">JSON 类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.4.</span> <span class="toc-text">表单类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E8%A1%A8%E5%8D%95%E5%A4%84%E7%90%86-form-data"><span class="toc-number">2.3.4.1.</span> <span class="toc-text">通用表单处理 form-data</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E8%A1%A8%E5%8D%95-x-www-form-ulrlencoded"><span class="toc-number">2.3.4.2.</span> <span class="toc-text">普通表单 x-www-form-ulrlencoded</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.3.5.</span> <span class="toc-text">文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E7%B1%BB%E5%9E%8B-text-plain"><span class="toc-number">2.3.6.</span> <span class="toc-text">文本类型 text&#x2F;plain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E6%A8%A1%E5%9D%97"><span class="toc-number">2.3.7.</span> <span class="toc-text">HTTP 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#request"><span class="toc-number">2.3.7.1.</span> <span class="toc-text">request</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#superagent"><span class="toc-number">2.3.7.2.</span> <span class="toc-text">superagent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#got"><span class="toc-number">2.3.7.3.</span> <span class="toc-text">got</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#node-fetch"><span class="toc-number">2.3.7.4.</span> <span class="toc-text">node-fetch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#axios"><span class="toc-number">2.3.7.5.</span> <span class="toc-text">axios</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API-%E5%BC%80%E5%8F%91"><span class="toc-number">2.4.</span> <span class="toc-text">API 开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#koa-res-api"><span class="toc-number">2.4.1.</span> <span class="toc-text">koa.res.api</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E5%A4%84%E7%90%86"><span class="toc-number">2.4.2.</span> <span class="toc-text">响应处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Loadsh"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">Loadsh</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TypeScript"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">TypeScript</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RESTful-API"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">RESTful API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#API-%E8%AE%BF%E9%97%AE%E9%89%B4%E6%9D%83"><span class="toc-number">2.4.2.4.</span> <span class="toc-text">API 访问鉴权</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JWT"><span class="toc-number">2.4.2.4.1.</span> <span class="toc-text">JWT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#OAuth"><span class="toc-number">2.4.2.4.2.</span> <span class="toc-text">OAuth</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">2.5.</span> <span class="toc-text">常用中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D"><span class="toc-number">2.5.1.</span> <span class="toc-text">会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ETag"><span class="toc-number">2.5.2.</span> <span class="toc-text">ETag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">2.5.3.</span> <span class="toc-text">验证码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AE%E9%A2%91%E7%8E%87"><span class="toc-number">2.5.4.</span> <span class="toc-text">限制访问频率</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">3.</span> <span class="toc-text">数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MVC"><span class="toc-number">3.1.</span> <span class="toc-text">MVC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">3.2.</span> <span class="toc-text">模型的代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84"><span class="toc-number">3.3.</span> <span class="toc-text">代码组织结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F"><span class="toc-number">3.3.1.</span> <span class="toc-text">安装与部署方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%87%E7%94%A8%E5%A4%8D%E5%88%B6%E9%9B%86-Replica-Set"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">采用复制集(Replica Set)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%87%E7%94%A8%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4-Sharding-Cluster"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">采用分片集群(Sharding Cluster)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Ubuntu%E4%B8%8A%E5%AE%89%E8%A3%85"><span class="toc-number">3.3.2.</span> <span class="toc-text">在Ubuntu上安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E5%A5%BD%E7%9A%84%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">3.3.3.</span> <span class="toc-text">更好的启动方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mongoose%E5%9F%BA%E7%A1%80"><span class="toc-number">3.4.</span> <span class="toc-text">Mongoose基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mongo-%E7%AE%80%E4%BB%8B"><span class="toc-number">3.4.1.</span> <span class="toc-text">Mongo 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">3.4.2.</span> <span class="toc-text">入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">测试连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">最小示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hello-Mongoose"><span class="toc-number">3.4.2.3.</span> <span class="toc-text">Hello Mongoose</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">3.4.3.</span> <span class="toc-text">核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%85%B3%E7%B3%BB%E6%98%A0%E5%B0%84"><span class="toc-number">3.4.3.1.</span> <span class="toc-text">对象关系映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Schema"><span class="toc-number">3.4.3.2.</span> <span class="toc-text">Schema</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.4.3.3.</span> <span class="toc-text">模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93"><span class="toc-number">3.4.3.4.</span> <span class="toc-text">实体</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-number">3.4.4.</span> <span class="toc-text">增删改查</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0"><span class="toc-number">3.4.4.1.</span> <span class="toc-text">增加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96"><span class="toc-number">3.4.4.2.</span> <span class="toc-text">读取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0"><span class="toc-number">3.4.4.3.</span> <span class="toc-text">更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4"><span class="toc-number">3.4.4.4.</span> <span class="toc-text">删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">3.4.4.5.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.4.4.6.</span> <span class="toc-text">调试模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Schema%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.4.4.7.</span> <span class="toc-text">Schema的类型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mongoose-%E8%BF%9B%E9%98%B6"><span class="toc-number">3.5.</span> <span class="toc-text">Mongoose 进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E6%89%A9%E5%B1%95"><span class="toc-number">3.5.1.</span> <span class="toc-text">模型扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E4%B8%8A%E6%89%A9%E5%B1%95"><span class="toc-number">3.5.1.1.</span> <span class="toc-text">类上扩展</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%B8%8A%E6%89%A9%E5%B1%95"><span class="toc-number">3.5.1.2.</span> <span class="toc-text">对象上扩展</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2022 By Wu Zhaoyi</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://hqwuzhaoyi.github.io/2020/04/07/node/68.%E7%8B%BC%E4%B9%A6/'
    this.page.identifier = '2020/04/07/node/68.狼书/'
    this.page.title = '狼书'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://wuzhaoyi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>